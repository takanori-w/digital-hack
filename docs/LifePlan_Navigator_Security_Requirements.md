# LifePlan Navigator セキュリティ要件定義書

**バージョン**: 1.0
**作成日**: 2025-12-11
**分類**: 機密 - 社内限定
**準拠規格**: NIST CSF 2.0, ISO 27001, GDPR, 個人情報保護法

---

## 1. 概要

### 1.1 プロジェクト概要
LifePlan Navigatorは、個人のライフプランニングを支援するWebアプリケーションです。

### 1.2 取り扱うデータ
| データ種別 | 機密レベル | 例 |
|-----------|-----------|-----|
| 認証情報 | 最高機密 | パスワードハッシュ、MFAシークレット |
| 金融情報 | 高機密 | 収入、資産、負債、口座情報 |
| 個人識別情報（PII） | 高機密 | 氏名、住所、生年月日、マイナンバー |
| 家族情報 | 中機密 | 家族構成、扶養状況 |
| ライフプランデータ | 中機密 | 目標、計画、シミュレーション結果 |

### 1.3 セキュリティ目標
- **機密性**: 個人情報の不正アクセス防止
- **完全性**: データの改ざん防止
- **可用性**: サービスの継続的提供（99.9% SLA）

---

## 2. 認証・認可要件

### 2.1 認証方式

#### 2.1.1 プライマリ認証
| 要件ID | 要件 | 優先度 |
|--------|------|--------|
| AUTH-001 | メールアドレス + パスワード認証を実装 | 必須 |
| AUTH-002 | パスワードは最低12文字、大小英数字記号を含む | 必須 |
| AUTH-003 | パスワードはbcrypt/Argon2でハッシュ化（コスト係数12以上） | 必須 |
| AUTH-004 | パスワード入力は最大5回/15分に制限（ブルートフォース対策） | 必須 |
| AUTH-005 | OAuth 2.0/OIDC対応（Google, Apple ID）をオプション提供 | 推奨 |

#### 2.1.2 多要素認証（MFA）
| 要件ID | 要件 | 優先度 |
|--------|------|--------|
| AUTH-010 | TOTP（Google Authenticator等）を必須実装 | 必須 |
| AUTH-011 | 金融情報へのアクセス時はMFA必須 | 必須 |
| AUTH-012 | MFAリカバリーコード（8桁×10個）を生成・暗号化保存 | 必須 |
| AUTH-013 | SMS認証は非推奨（SIMスワップ攻撃リスク） | 注意 |
| AUTH-014 | WebAuthn/FIDO2対応（将来実装） | 推奨 |

#### 2.1.3 パスワードポリシー
```
最小長: 12文字
最大長: 128文字
複雑性: 大文字、小文字、数字、記号のうち3種以上
禁止: 過去5世代のパスワード再利用禁止
有効期限: 365日（金融情報アクセス権限者は90日）
漏洩チェック: Have I Been Pwned API連携
```

### 2.2 セッション管理

| 要件ID | 要件 | 優先度 |
|--------|------|--------|
| SESS-001 | セッションIDは256ビット以上のCSPRNGで生成 | 必須 |
| SESS-002 | セッション有効期限: 30分（アイドルタイムアウト） | 必須 |
| SESS-003 | 絶対タイムアウト: 8時間 | 必須 |
| SESS-004 | 認証成功後はセッションID再生成（Session Fixation対策） | 必須 |
| SESS-005 | Secure, HttpOnly, SameSite=Strict属性を設定 | 必須 |
| SESS-006 | 同時セッション数を3つに制限 | 推奨 |
| SESS-007 | 異常検知時（IP急変等）は再認証要求 | 推奨 |

### 2.3 アクセス制御

#### 2.3.1 RBAC（ロールベースアクセス制御）
| ロール | 権限 | 説明 |
|--------|------|------|
| user | 自己データのCRUD | 一般ユーザー |
| family_member | 参照のみ（共有設定時） | 家族共有メンバー |
| support | 参照のみ（同意取得時） | カスタマーサポート |
| admin | システム管理（PIIアクセス不可） | システム管理者 |
| super_admin | 全権限（監査ログ必須） | 特権管理者 |

#### 2.3.2 権限要件
| 要件ID | 要件 | 優先度 |
|--------|------|--------|
| AUTHZ-001 | 最小権限の原則を適用 | 必須 |
| AUTHZ-002 | 全APIエンドポイントで認可チェック実施 | 必須 |
| AUTHZ-003 | オブジェクトレベル認可（IDOR対策） | 必須 |
| AUTHZ-004 | 管理者アクセスは専用VPN経由のみ | 必須 |
| AUTHZ-005 | 特権操作は2名以上の承認（Dual Control） | 推奨 |

---

## 3. データ保護要件

### 3.1 暗号化

#### 3.1.1 通信時の暗号化（In Transit）
| 要件ID | 要件 | 優先度 |
|--------|------|--------|
| ENC-001 | TLS 1.3必須（TLS 1.2は許容、1.1以下は禁止） | 必須 |
| ENC-002 | HSTS有効化（max-age=31536000, includeSubDomains） | 必須 |
| ENC-003 | Certificate Transparency対応 | 必須 |
| ENC-004 | 証明書はEV SSL推奨 | 推奨 |

#### 3.1.2 保存時の暗号化（At Rest）
| 要件ID | 要件 | 優先度 |
|--------|------|--------|
| ENC-010 | データベース全体をAES-256で暗号化 | 必須 |
| ENC-011 | 機密カラムはアプリケーションレベルで追加暗号化 | 必須 |
| ENC-012 | 暗号化キーはHSMまたはKMSで管理 | 必須 |
| ENC-013 | キーローテーション: 年1回以上 | 必須 |
| ENC-014 | バックアップデータも暗号化 | 必須 |

#### 3.1.3 機密データの暗号化方式
```
金融情報（収入、資産）: AES-256-GCM + Envelope Encryption
マイナンバー: AES-256-GCM（専用キー、アクセスログ必須）
パスワード: Argon2id（memory=64MB, iterations=3, parallelism=4）
APIキー/トークン: AES-256-GCM + HMAC検証
```

### 3.2 個人情報のマスキング

| 要件ID | 要件 | 適用場面 |
|--------|------|----------|
| MASK-001 | メールアドレス: `a***@example.com` | ログ、CS画面 |
| MASK-002 | 電話番号: `090-****-1234` | ログ、CS画面 |
| MASK-003 | 収入/資産: `***万円` または `非表示` | 共有時、ログ |
| MASK-004 | マイナンバー: 表示禁止（入力確認時のみ末尾4桁） | 全場面 |
| MASK-005 | 生年月日: `19**年**月**日` | ログ |

### 3.3 データ保持・削除

| データ種別 | 保持期間 | 削除方式 |
|-----------|----------|----------|
| アクティブユーザーデータ | 無期限 | 退会時に削除 |
| 退会ユーザーデータ | 退会後30日 | 完全削除（復旧不可） |
| 監査ログ | 7年間 | 法的要件に基づく |
| セッションログ | 90日間 | 自動削除 |
| バックアップ | 35日間 | 世代管理で自動削除 |

#### 3.3.1 削除要件
| 要件ID | 要件 | 優先度 |
|--------|------|--------|
| DEL-001 | GDPR「忘れられる権利」に対応 | 必須 |
| DEL-002 | 削除リクエストは72時間以内に処理 | 必須 |
| DEL-003 | バックアップからも30日以内に削除 | 必須 |
| DEL-004 | 削除証明書を発行 | 推奨 |

---

## 4. アプリケーションセキュリティ要件

### 4.1 OWASP Top 10 対策

| 脆弱性 | 対策要件 | 要件ID |
|--------|----------|--------|
| A01:2021 アクセス制御の不備 | オブジェクトレベル認可、RBAC実装 | APP-001 |
| A02:2021 暗号化の失敗 | 強力な暗号化、キー管理 | APP-002 |
| A03:2021 インジェクション | Prepared Statement必須、ORM使用 | APP-003 |
| A04:2021 安全でない設計 | 脅威モデリング、セキュアデザインレビュー | APP-004 |
| A05:2021 セキュリティ設定ミス | セキュリティベースライン、自動チェック | APP-005 |
| A06:2021 脆弱なコンポーネント | 依存関係スキャン（Snyk/Dependabot） | APP-006 |
| A07:2021 認証の不備 | MFA必須、セッション管理強化 | APP-007 |
| A08:2021 ソフトウェアの整合性 | CI/CDセキュリティ、署名検証 | APP-008 |
| A09:2021 ログと監視の不備 | 包括的ログ、SIEM連携 | APP-009 |
| A10:2021 SSRF | URL検証、内部ネットワークブロック | APP-010 |

### 4.2 入力バリデーション

| 要件ID | 要件 | 優先度 |
|--------|------|--------|
| VAL-001 | サーバーサイドでの入力検証必須 | 必須 |
| VAL-002 | ホワイトリスト方式での検証 | 必須 |
| VAL-003 | 文字エンコーディングはUTF-8に統一 | 必須 |
| VAL-004 | ファイルアップロード: 種類・サイズ制限、マルウェアスキャン | 必須 |
| VAL-005 | JSON Schema/OpenAPIでの入力定義 | 推奨 |

#### 入力制限例
```
メールアドレス: RFC 5322準拠、最大254文字
電話番号: E.164形式、最大15桁
金額: 正の整数、最大10桁
テキスト: 最大10,000文字、HTML/Script無効化
```

### 4.3 CSRF/XSS対策

| 要件ID | 要件 | 優先度 |
|--------|------|--------|
| WEB-001 | CSRFトークン（Synchronizer Token Pattern） | 必須 |
| WEB-002 | SameSite Cookie属性（Strict/Lax） | 必須 |
| WEB-003 | Content-Security-Policy（CSP）ヘッダー設定 | 必須 |
| WEB-004 | 出力エスケープ（コンテキストに応じた処理） | 必須 |
| WEB-005 | X-Content-Type-Options: nosniff | 必須 |
| WEB-006 | X-Frame-Options: DENY | 必須 |

#### CSPポリシー例
```
Content-Security-Policy:
  default-src 'self';
  script-src 'self' 'nonce-{random}';
  style-src 'self' 'unsafe-inline';
  img-src 'self' data: https:;
  font-src 'self';
  connect-src 'self' https://api.lifeplan-navigator.example.com;
  frame-ancestors 'none';
  base-uri 'self';
  form-action 'self';
```

### 4.4 APIセキュリティ

| 要件ID | 要件 | 優先度 |
|--------|------|--------|
| API-001 | RESTful APIはJWT（RS256）で認証 | 必須 |
| API-002 | JWTの有効期限: 15分（リフレッシュトークン: 7日） | 必須 |
| API-003 | レートリミット: 100リクエスト/分/ユーザー | 必須 |
| API-004 | API バージョニング必須 | 必須 |
| API-005 | エラーレスポンスで機密情報を漏洩しない | 必須 |

---

## 5. インフラセキュリティ要件

### 5.1 ネットワーク分離

```
┌─────────────────────────────────────────────────────────────┐
│                        Internet                              │
└─────────────────────────┬───────────────────────────────────┘
                          │
                    ┌─────▼─────┐
                    │   WAF     │  ← DDoS保護、OWASP CRS
                    │ (Cloudflare)
                    └─────┬─────┘
                          │
┌─────────────────────────┼───────────────────────────────────┐
│  DMZ (Public Subnet)    │                                    │
│  ┌─────────────────────▼──────────────────────┐             │
│  │        Load Balancer (ALB)                  │             │
│  └─────────────────────┬──────────────────────┘             │
└─────────────────────────┼───────────────────────────────────┘
                          │
┌─────────────────────────┼───────────────────────────────────┐
│  Application Subnet     │    (Private)                       │
│  ┌──────────────────────▼─────────────────────┐             │
│  │         Web/API Servers (ECS/EKS)          │             │
│  └──────────────────────┬─────────────────────┘             │
└─────────────────────────┼───────────────────────────────────┘
                          │
┌─────────────────────────┼───────────────────────────────────┐
│  Data Subnet            │    (Private, Isolated)             │
│  ┌──────────────────────▼─────────────────────┐             │
│  │    RDS (PostgreSQL) + ElastiCache (Redis)  │             │
│  └────────────────────────────────────────────┘             │
└─────────────────────────────────────────────────────────────┘
```

| 要件ID | 要件 | 優先度 |
|--------|------|--------|
| NET-001 | 3層ネットワーク分離（DMZ、App、Data） | 必須 |
| NET-002 | データベースはインターネット非公開 | 必須 |
| NET-003 | セキュリティグループで最小限のポート開放 | 必須 |
| NET-004 | VPCフローログ有効化 | 必須 |
| NET-005 | 管理アクセスはVPN/踏み台サーバー経由 | 必須 |

### 5.2 ログ管理・監視

#### 5.2.1 ログ収集要件
| ログ種別 | 保持期間 | 内容 |
|----------|----------|------|
| 認証ログ | 2年 | ログイン/ログアウト、MFA、失敗 |
| アクセスログ | 1年 | 全HTTPリクエスト |
| 監査ログ | 7年 | データ変更、権限変更、設定変更 |
| エラーログ | 90日 | アプリケーションエラー |
| セキュリティログ | 2年 | WAFブロック、侵入検知 |

#### 5.2.2 監視要件
| 要件ID | 要件 | 優先度 |
|--------|------|--------|
| MON-001 | SIEM導入（Splunk/Elastic SIEM） | 必須 |
| MON-002 | リアルタイムアラート（異常検知） | 必須 |
| MON-003 | ログの改ざん防止（WORM/署名） | 必須 |
| MON-004 | ログへのPII含めない（マスキング済み） | 必須 |

#### 5.2.3 検知ルール例
```
- 同一アカウントへの5回連続ログイン失敗 → アラート + アカウントロック
- 異常な時間帯（深夜）の管理者アクセス → アラート
- 大量データエクスポート（1000件以上） → アラート + 承認待ち
- 新規IPアドレスからのアクセス → 追加認証要求
```

### 5.3 バックアップ・DR

| 要件ID | 要件 | 優先度 |
|--------|------|--------|
| BK-001 | 日次自動バックアップ | 必須 |
| BK-002 | バックアップの暗号化（AES-256） | 必須 |
| BK-003 | 地理的分散（別リージョンへのレプリケーション） | 必須 |
| BK-004 | RPO: 1時間、RTO: 4時間 | 必須 |
| BK-005 | 四半期ごとのDR訓練 | 推奨 |

---

## 6. 脅威モデリング

### 6.1 STRIDE分析

| 脅威 | シナリオ | 対策 | リスクレベル |
|------|----------|------|--------------|
| **S**poofing (なりすまし) | 盗まれた認証情報でのログイン | MFA必須、異常検知 | 高 |
| **T**ampering (改ざん) | 金融データの改ざん | 整合性チェック、監査ログ | 高 |
| **R**epudiation (否認) | 操作の否認 | 改ざん不可能な監査ログ | 中 |
| **I**nformation Disclosure (情報漏洩) | DBへの不正アクセス | 暗号化、アクセス制御 | 最高 |
| **D**enial of Service (DoS) | サービス停止攻撃 | WAF、レートリミット、CDN | 中 |
| **E**levation of Privilege (権限昇格) | 管理者権限の不正取得 | RBAC、最小権限、監査 | 高 |

### 6.2 攻撃シナリオと対策

#### シナリオ1: クレデンシャルスタッフィング攻撃
```
攻撃: 漏洩したID/パスワードリストによる自動ログイン試行
影響: アカウント乗っ取り、金融情報漏洩
対策:
  - MFA必須化
  - ログイン試行回数制限（5回/15分）
  - Have I Been Pwned APIでの漏洩パスワードチェック
  - CAPTCHAの導入
  - 異常IPからのアクセスブロック
```

#### シナリオ2: SQLインジェクション
```
攻撃: 検索機能への悪意あるSQL挿入
影響: データベース全体の漏洩
対策:
  - Prepared Statement/パラメータ化クエリ必須
  - ORM使用（raw SQL禁止）
  - WAFでのSQLi検知
  - DB権限の最小化（SELECT ONLYユーザー）
```

#### シナリオ3: 内部不正
```
攻撃: 従業員による顧客データの不正持ち出し
影響: 大量の個人情報漏洩
対策:
  - 本番環境へのアクセス制限
  - 全アクセスの監査ログ
  - 大量データエクスポートの承認フロー
  - DLP（Data Loss Prevention）導入
```

### 6.3 データフロー図（DFD）

```
┌──────────┐         HTTPS          ┌──────────┐
│  User    │◄──────────────────────►│   CDN    │
│ Browser  │                        │  (WAF)   │
└──────────┘                        └────┬─────┘
                                         │
                                    ┌────▼─────┐
                                    │   ALB    │
                                    └────┬─────┘
                                         │
┌────────────────────────────────────────┼────────────────────────────────────┐
│  Trust Boundary: Application Zone      │                                     │
│                                   ┌────▼─────┐                              │
│                                   │  API     │                              │
│                                   │ Server   │                              │
│                                   └────┬─────┘                              │
│                                        │                                     │
│              ┌─────────────────────────┼─────────────────────────┐          │
│              │                         │                         │          │
│         ┌────▼─────┐             ┌────▼─────┐             ┌────▼─────┐    │
│         │ Session  │             │  Redis   │             │  KMS     │    │
│         │  Store   │             │  Cache   │             │ (Keys)   │    │
│         └──────────┘             └──────────┘             └──────────┘    │
│                                                                            │
└────────────────────────────────────────┬────────────────────────────────────┘
                                         │
┌────────────────────────────────────────┼────────────────────────────────────┐
│  Trust Boundary: Data Zone             │                                     │
│                                   ┌────▼─────┐                              │
│                                   │PostgreSQL│ ← 暗号化済み                 │
│                                   │   RDS    │                              │
│                                   └──────────┘                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 7. セキュリティチェックリスト

### 7.1 開発フェーズ

| # | チェック項目 | 実施者 | 完了 |
|---|-------------|--------|------|
| 1 | セキュアコーディングガイドラインの遵守 | 開発者 | ☐ |
| 2 | コードレビューでのセキュリティチェック | レビュアー | ☐ |
| 3 | SAST（静的解析）の実行 | CI/CD | ☐ |
| 4 | 依存関係の脆弱性スキャン | CI/CD | ☐ |
| 5 | シークレットのハードコード禁止確認 | CI/CD | ☐ |
| 6 | 単体テストでのセキュリティテストケース | 開発者 | ☐ |

### 7.2 テストフェーズ

| # | チェック項目 | 実施者 | 完了 |
|---|-------------|--------|------|
| 1 | DAST（動的解析）の実行 | QA | ☐ |
| 2 | ペネトレーションテスト | White Hacker | ☐ |
| 3 | 認証・認可のテスト | QA | ☐ |
| 4 | 入力バリデーションのテスト | QA | ☐ |
| 5 | セッション管理のテスト | QA | ☐ |
| 6 | 暗号化の実装確認 | セキュリティチーム | ☐ |

### 7.3 デプロイフェーズ

| # | チェック項目 | 実施者 | 完了 |
|---|-------------|--------|------|
| 1 | インフラセキュリティ設定の確認 | Network Engineer | ☐ |
| 2 | セキュリティグループ/ファイアウォール確認 | Network Engineer | ☐ |
| 3 | SSL/TLS設定の確認 | DevOps | ☐ |
| 4 | ログ収集の動作確認 | SOC Analyst | ☐ |
| 5 | 監視アラートの動作確認 | SOC Analyst | ☐ |
| 6 | バックアップの動作確認 | DevOps | ☐ |

### 7.4 運用フェーズ

| # | チェック項目 | 頻度 | 実施者 |
|---|-------------|------|--------|
| 1 | 脆弱性スキャン | 週次 | SOC Analyst |
| 2 | パッチ適用状況確認 | 週次 | DevOps |
| 3 | アクセスログレビュー | 日次 | SOC Analyst |
| 4 | 特権アカウント棚卸し | 月次 | Auditor |
| 5 | DR訓練 | 四半期 | CSIRT Team |
| 6 | ペネトレーションテスト | 年次 | White Hacker |

---

## 8. コンプライアンス対応

### 8.1 個人情報保護法（日本）
- 利用目的の明示と同意取得
- 第三者提供の制限
- 開示・訂正・削除請求への対応
- 安全管理措置の実施
- 漏洩時の報告義務（72時間以内）

### 8.2 GDPR（EU居住者対応時）
- 明示的同意の取得
- データポータビリティ対応
- 忘れられる権利への対応
- DPO（Data Protection Officer）の設置検討
- 越境データ移転の適法化

### 8.3 金融関連規制
- 金融商品取引法に基づく情報管理
- 犯罪収益移転防止法（本人確認）
- 銀行口座連携時のAPIセキュリティ

---

## 9. 参考資料

- [OWASP Top 10 2021](https://owasp.org/Top10/)
- [OWASP ASVS v4.0](https://owasp.org/www-project-application-security-verification-standard/)
- [NIST SP 800-53](https://csrc.nist.gov/publications/detail/sp/800-53/rev-5/final)
- [CIS Controls v8](https://www.cisecurity.org/controls/v8)

---

## 10. 改訂履歴

| バージョン | 日付 | 変更内容 | 承認者 |
|-----------|------|----------|--------|
| 1.0 | 2025-12-11 | 初版作成 | CISO |

---

**承認**

| 役職 | 氏名 | 署名 | 日付 |
|------|------|------|------|
| CTO | | | |
| CISO | | | |
| CLO | | | |
