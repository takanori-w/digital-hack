# LifePlan Navigator - 脆弱性診断レポート

**診断日**: 2025-12-11
**診断担当**: White Hacker (Security Assessment Team)
**対象アプリケーション**: LifePlan Navigator
**技術スタック**: Next.js 14.2.0 + TypeScript + Tailwind CSS + Zustand
**診断種別**: ペネトレーションテスト（ホワイトボックス）

---

## 1. エグゼクティブサマリー

### 1.1 総合評価

| 評価項目 | 結果 |
|----------|------|
| **総合リスクレベル** | Medium |
| **発見脆弱性数** | 12件 |
| **Critical** | 1件 |
| **High** | 3件 |
| **Medium** | 5件 |
| **Low** | 3件 |

### 1.2 主要所見

本アプリケーションはフロントエンドのみで構成されており、バックエンドAPIは存在しません。
主なセキュリティ上の懸念は以下の通りです：

1. **クライアントサイドストレージの個人情報保護不足**（Critical）
2. **XSS攻撃に対する脆弱性**（High）
3. **セキュリティヘッダーの未設定**（High）
4. **入力検証の不足**（Medium）

---

## 2. 発見脆弱性一覧

### 2.1 Critical（深刻）

#### VULN-001: LocalStorageへの機密情報の平文保存

| 項目 | 内容 |
|------|------|
| **CVSS v3.1** | 8.1 (High) |
| **CWE** | CWE-312: Cleartext Storage of Sensitive Information |
| **OWASP Top 10** | A02:2021 - Cryptographic Failures |
| **該当ファイル** | `src/lib/store.ts:116-119` |

**詳細**:
Zustandの`persist`ミドルウェアにより、ユーザーの個人情報（氏名、メールアドレス、生年月日、年収、居住地など）がLocalStorageに平文で保存されています。

```typescript
// src/lib/store.ts:116-119
persist(
  (set) => ({...}),
  {
    name: 'lifeplan-storage',  // LocalStorageのキー
  }
)
```

**保存される機密情報**:
- 氏名（`name`）
- メールアドレス（`email`）
- 生年月日（`birthDate`）
- 年収（`annualIncome`）
- 居住地（`prefecture`, `city`）
- 家族構成（`householdSize`, `numberOfChildren`）

**影響**:
- XSS攻撃によりLocalStorageの内容が窃取される
- 共有端末でのデータ漏洩
- ブラウザ拡張機能による不正アクセス
- 物理的アクセスによるデータ取得

**推奨対策**:
1. 機密情報はサーバーサイドで管理し、セッショントークンのみをクライアントに保存
2. やむを得ずクライアントに保存する場合は暗号化を実施
3. SessionStorageの使用を検討（タブ閉じ時にデータ削除）

---

### 2.2 High（高）

#### VULN-002: XSS（クロスサイトスクリプティング）脆弱性

| 項目 | 内容 |
|------|------|
| **CVSS v3.1** | 7.1 (High) |
| **CWE** | CWE-79: Improper Neutralization of Input During Web Page Generation |
| **OWASP Top 10** | A03:2021 - Injection |
| **該当ファイル** | 複数のコンポーネント |

**詳細**:
以下のコンポーネントでユーザー入力値が適切にサニタイズされずに表示されています。

1. **Dashboard.tsx:84** - ユーザー名の直接表示
```typescript
{user?.name || 'ゲスト'}
```

2. **NotificationPanel.tsx:71-76** - 通知メッセージの表示
```typescript
<h4 className="font-medium text-sm text-gray-900">{notification.title}</h4>
<p className="text-xs text-gray-600 mt-1">{notification.message}</p>
```

3. **BenefitCard.tsx:62-63** - 外部データの表示
```typescript
<h3 className="font-semibold text-gray-900 mb-2">{benefit.title}</h3>
<p className="text-sm text-gray-600 mb-3 line-clamp-2">{benefit.description}</p>
```

**影響**:
- 将来的にバックエンドからデータを取得する場合、悪意のあるスクリプトが実行される可能性
- LocalStorageの機密情報の窃取
- セッションハイジャック
- フィッシング攻撃

**推奨対策**:
1. DOMPurifyなどのサニタイズライブラリの導入
2. Content Security Policy (CSP) の設定
3. 入力値のエスケープ処理の実装

---

#### VULN-003: セキュリティヘッダーの未設定

| 項目 | 内容 |
|------|------|
| **CVSS v3.1** | 6.5 (Medium) |
| **CWE** | CWE-693: Protection Mechanism Failure |
| **OWASP Top 10** | A05:2021 - Security Misconfiguration |
| **該当ファイル** | `next.config.js` |

**詳細**:
Next.jsの設定ファイルにセキュリティヘッダーが設定されていません。

```javascript
// next.config.js - セキュリティヘッダー未設定
const nextConfig = {
  reactStrictMode: true,
}
```

**不足しているヘッダー**:
- `Content-Security-Policy`
- `X-Content-Type-Options`
- `X-Frame-Options`
- `X-XSS-Protection`
- `Strict-Transport-Security`
- `Referrer-Policy`
- `Permissions-Policy`

**推奨対策**:
```javascript
// next.config.js
const nextConfig = {
  reactStrictMode: true,
  async headers() {
    return [
      {
        source: '/:path*',
        headers: [
          {
            key: 'Content-Security-Policy',
            value: "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' https://fonts.gstatic.com;"
          },
          {
            key: 'X-Content-Type-Options',
            value: 'nosniff'
          },
          {
            key: 'X-Frame-Options',
            value: 'DENY'
          },
          {
            key: 'X-XSS-Protection',
            value: '1; mode=block'
          },
          {
            key: 'Referrer-Policy',
            value: 'strict-origin-when-cross-origin'
          },
          {
            key: 'Permissions-Policy',
            value: 'camera=(), microphone=(), geolocation=()'
          }
        ]
      }
    ]
  }
}
```

---

#### VULN-004: 外部URLへの未検証リダイレクト

| 項目 | 内容 |
|------|------|
| **CVSS v3.1** | 6.1 (Medium) |
| **CWE** | CWE-601: URL Redirection to Untrusted Site |
| **OWASP Top 10** | A03:2021 - Injection |
| **該当ファイル** | `src/types/index.ts:56`, `src/data/mockData.ts` |

**詳細**:
`BenefitInfo`型に`applicationUrl`フィールドが定義されており、将来的に外部URLへのリダイレクトが実装される可能性があります。

```typescript
// src/types/index.ts:56
applicationUrl?: string;
```

現在はモックデータのため直接的な脆弱性はありませんが、本番実装時に適切な検証が必要です。

**推奨対策**:
1. 許可リスト（ホワイトリスト）によるURL検証
2. 外部サイトへのリダイレクト時に警告表示
3. `rel="noopener noreferrer"` 属性の付与

---

### 2.3 Medium（中）

#### VULN-005: 入力検証の不足

| 項目 | 内容 |
|------|------|
| **CVSS v3.1** | 5.3 (Medium) |
| **CWE** | CWE-20: Improper Input Validation |
| **OWASP Top 10** | A03:2021 - Injection |
| **該当ファイル** | `src/lib/store.ts`, `src/types/index.ts` |

**詳細**:
TypeScriptの型定義は存在しますが、ランタイムでの入力検証が実装されていません。

```typescript
// src/lib/store.ts:43
updateUser: (updates) =>
  set((state) => ({
    user: state.user ? { ...state.user, ...updates, updatedAt: new Date().toISOString() } : null,
  })),
```

**脆弱な箇所**:
- `updateUser` - 任意のプロパティを上書き可能
- `addAction` - 未検証のアクションを追加可能
- `addNotification` - 未検証の通知を追加可能

**推奨対策**:
1. Zodなどのバリデーションライブラリの導入
2. ランタイム型チェックの実装
3. 数値範囲、文字列長、フォーマットの検証

---

#### VULN-006: シミュレーション計算結果の改ざん可能性

| 項目 | 内容 |
|------|------|
| **CVSS v3.1** | 4.3 (Medium) |
| **CWE** | CWE-472: External Control of Assumed-Immutable Web Parameter |
| **OWASP Top 10** | A04:2021 - Insecure Design |
| **該当ファイル** | `src/lib/simulation.ts` |

**詳細**:
シミュレーションパラメータがクライアントサイドで完全に制御されており、DevToolsから直接操作可能です。

```typescript
// src/lib/simulation.ts:4-7
export function runSimulation(
  params: SimulationParams,
  scenario: ScenarioConfig
): SimulationResult[] {
```

**影響**:
- 不正なパラメータによる誤った結果表示
- 金融アドバイスの改ざん
- ユーザーの誤った意思決定を誘発

**推奨対策**:
1. 重要な計算はサーバーサイドで実行
2. パラメータの妥当性検証
3. 結果の署名・検証機能の追加

---

#### VULN-007: エラーハンドリングの不足

| 項目 | 内容 |
|------|------|
| **CVSS v3.1** | 4.0 (Medium) |
| **CWE** | CWE-755: Improper Handling of Exceptional Conditions |
| **OWASP Top 10** | A05:2021 - Security Misconfiguration |
| **該当ファイル** | 全体 |

**詳細**:
try-catchによるエラーハンドリングが実装されておらず、予期しないエラーが発生した場合の挙動が未定義です。

**推奨対策**:
1. Error Boundary の実装
2. 適切なエラーメッセージの表示
3. センシティブ情報のエラーメッセージへの露出防止

---

#### VULN-008: 認証・認可機能の欠如

| 項目 | 内容 |
|------|------|
| **CVSS v3.1** | 5.0 (Medium) |
| **CWE** | CWE-306: Missing Authentication for Critical Function |
| **OWASP Top 10** | A01:2021 - Broken Access Control |
| **該当ファイル** | 全体 |

**詳細**:
現在のアプリケーションには認証・認可機能が実装されていません。「ログイン」ボタンはモックデータの読み込みのみを行います。

```typescript
// src/components/LandingPage.tsx:9-12
const handleStart = () => {
  initializeMockData();
  setOnboardingCompleted(true);
};
```

**推奨対策**:
1. 認証システムの実装（NextAuth.js等）
2. セッション管理の実装
3. RBAC（ロールベースアクセス制御）の導入

---

#### VULN-009: CSRF対策の欠如

| 項目 | 内容 |
|------|------|
| **CVSS v3.1** | 4.3 (Medium) |
| **CWE** | CWE-352: Cross-Site Request Forgery |
| **OWASP Top 10** | A01:2021 - Broken Access Control |
| **該当ファイル** | 該当なし（API未実装） |

**詳細**:
現時点でAPIが存在しないためCSRF攻撃のリスクは低いですが、今後APIを実装する際にはCSRF対策が必須です。

**推奨対策**:
1. CSRFトークンの実装
2. SameSite Cookie属性の設定
3. Refererヘッダーの検証

---

### 2.4 Low（低）

#### VULN-010: 依存パッケージのセキュリティ

| 項目 | 内容 |
|------|------|
| **CVSS v3.1** | 3.1 (Low) |
| **CWE** | CWE-1104: Use of Unmaintained Third Party Components |
| **OWASP Top 10** | A06:2021 - Vulnerable and Outdated Components |
| **該当ファイル** | `package.json` |

**詳細**:
依存パッケージのバージョンが固定されていますが、定期的なセキュリティアップデートが必要です。

```json
{
  "dependencies": {
    "next": "14.2.0",
    "react": "^18.3.0",
    "zustand": "^4.5.0"
  }
}
```

**推奨対策**:
1. `npm audit` の定期実行
2. Dependabot等の自動更新ツールの導入
3. 脆弱性データベースのモニタリング

---

#### VULN-011: 情報漏洩（コメント・メタデータ）

| 項目 | 内容 |
|------|------|
| **CVSS v3.1** | 2.6 (Low) |
| **CWE** | CWE-200: Exposure of Sensitive Information |
| **OWASP Top 10** | A05:2021 - Security Misconfiguration |
| **該当ファイル** | `src/data/mockData.ts` |

**詳細**:
モックデータに実際のメールアドレス形式やリアルな個人情報パターンが含まれています。

```typescript
// src/data/mockData.ts:197
email: 'taro.yamada@example.com',
```

本番環境ではモックデータが残らないよう注意が必要です。

**推奨対策**:
1. 本番ビルド時のモックデータ除去
2. 環境変数による切り替え
3. ダミーデータの匿名化

---

#### VULN-012: デバッグ情報の露出

| 項目 | 内容 |
|------|------|
| **CVSS v3.1** | 2.0 (Low) |
| **CWE** | CWE-215: Insertion of Sensitive Information Into Debugging Code |
| **OWASP Top 10** | A05:2021 - Security Misconfiguration |
| **該当ファイル** | 全体 |

**詳細**:
本番環境でのReact DevTools、Redux DevToolsへのアクセスを制限する設定がありません。

**推奨対策**:
1. 本番ビルドでのDevTools無効化
2. ソースマップの非公開設定
3. エラースタックトレースの非表示

---

## 3. OWASP Top 10 (2021) 診断結果

| # | カテゴリ | 結果 | 詳細 |
|---|----------|------|------|
| A01 | Broken Access Control | 該当 | 認証・認可未実装 |
| A02 | Cryptographic Failures | 該当 | LocalStorageへの平文保存 |
| A03 | Injection | 該当 | XSS脆弱性の可能性 |
| A04 | Insecure Design | 該当 | クライアントサイド完結の設計 |
| A05 | Security Misconfiguration | 該当 | セキュリティヘッダー未設定 |
| A06 | Vulnerable and Outdated Components | 要確認 | 定期監査必要 |
| A07 | Identification and Authentication Failures | 該当 | 認証機能未実装 |
| A08 | Software and Data Integrity Failures | 低リスク | - |
| A09 | Security Logging and Monitoring Failures | 該当 | ログ機能未実装 |
| A10 | Server-Side Request Forgery | 非該当 | サーバーサイド処理なし |

---

## 4. 診断対象外項目

以下の項目は現在のアプリケーション構成上、診断対象外としました：

| 項目 | 理由 |
|------|------|
| SQLインジェクション | データベース接続なし |
| サーバーサイドインジェクション | サーバーサイド処理なし |
| 認証バイパス | 認証機能未実装 |
| APIレート制限 | API未実装 |
| セッション固定攻撃 | セッション管理未実装 |

---

## 5. 推奨対策の優先順位

### 即座に対応が必要（Critical/High）

1. **セキュリティヘッダーの設定** - VULN-003
   - 実装難易度: 低
   - 効果: 高

2. **機密情報の保護強化** - VULN-001
   - 実装難易度: 中
   - 効果: 高

3. **XSS対策の実装** - VULN-002
   - 実装難易度: 中
   - 効果: 高

### 短期対応（Medium）

4. **入力検証の実装** - VULN-005
5. **Error Boundaryの実装** - VULN-007
6. **シミュレーション検証の強化** - VULN-006

### 中長期対応（設計レベル）

7. **認証・認可システムの実装** - VULN-008
8. **バックエンドAPIの構築**
9. **監査ログの実装**

---

## 6. 修正コード例

### 6.1 next.config.js（セキュリティヘッダー追加）

```javascript
/** @type {import('next').NextConfig} */
const nextConfig = {
  reactStrictMode: true,
  poweredByHeader: false,
  async headers() {
    return [
      {
        source: '/:path*',
        headers: [
          {
            key: 'X-DNS-Prefetch-Control',
            value: 'on'
          },
          {
            key: 'Strict-Transport-Security',
            value: 'max-age=63072000; includeSubDomains; preload'
          },
          {
            key: 'X-Content-Type-Options',
            value: 'nosniff'
          },
          {
            key: 'X-Frame-Options',
            value: 'DENY'
          },
          {
            key: 'X-XSS-Protection',
            value: '1; mode=block'
          },
          {
            key: 'Referrer-Policy',
            value: 'strict-origin-when-cross-origin'
          },
          {
            key: 'Permissions-Policy',
            value: 'camera=(), microphone=(), geolocation=(), interest-cohort=()'
          },
          {
            key: 'Content-Security-Policy',
            value: "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' https://fonts.gstatic.com; connect-src 'self'"
          }
        ]
      }
    ]
  }
}

module.exports = nextConfig
```

### 6.2 store.ts（暗号化オプション付きストレージ）

```typescript
import { create } from 'zustand';
import { persist, createJSONStorage } from 'zustand/middleware';

// 簡易的な暗号化（本番環境ではより堅牢な実装が必要）
const encryptStorage = {
  getItem: (name: string) => {
    const str = sessionStorage.getItem(name);
    if (!str) return null;
    try {
      // 本番環境では適切な復号化処理を実装
      return JSON.parse(atob(str));
    } catch {
      return null;
    }
  },
  setItem: (name: string, value: unknown) => {
    // 本番環境では適切な暗号化処理を実装
    sessionStorage.setItem(name, btoa(JSON.stringify(value)));
  },
  removeItem: (name: string) => {
    sessionStorage.removeItem(name);
  },
};

export const useAppStore = create<AppState>()(
  persist(
    (set) => ({
      // ... existing code
    }),
    {
      name: 'lifeplan-storage',
      storage: createJSONStorage(() => encryptStorage),
      partialize: (state) => ({
        // 機密情報を除外
        onboardingCompleted: state.onboardingCompleted,
        currentLifeStage: state.currentLifeStage,
        // user情報は保存しない（セッション毎に要求）
      }),
    }
  )
);
```

### 6.3 入力検証（Zod使用例）

```typescript
import { z } from 'zod';

const UserProfileSchema = z.object({
  id: z.string().uuid(),
  name: z.string().min(1).max(100),
  email: z.string().email(),
  birthDate: z.string().regex(/^\d{4}-\d{2}-\d{2}$/),
  gender: z.enum(['male', 'female', 'other']),
  prefecture: z.string().min(1).max(50),
  city: z.string().min(1).max(100),
  occupation: z.string().max(100),
  annualIncome: z.number().min(0).max(1000000000),
  householdSize: z.number().int().min(1).max(20),
  maritalStatus: z.enum(['single', 'married', 'divorced', 'widowed']),
  hasChildren: z.boolean(),
  numberOfChildren: z.number().int().min(0).max(20),
  childrenAges: z.array(z.number().int().min(0).max(100)),
  housingType: z.enum(['rent', 'own', 'with_parents']),
});

// 使用例
function validateAndUpdateUser(updates: unknown) {
  const result = UserProfileSchema.partial().safeParse(updates);
  if (!result.success) {
    console.error('Validation error:', result.error);
    return false;
  }
  // 検証済みデータで更新
  useAppStore.getState().updateUser(result.data);
  return true;
}
```

---

## 7. 再診断について

修正完了後、以下の項目について再診断を推奨します：

1. セキュリティヘッダーの有効性確認
2. XSS攻撃シナリオのテスト
3. LocalStorage/SessionStorageのデータ確認
4. 入力検証のバイパステスト

---

## 8. 参考情報

- [OWASP Top 10 2021](https://owasp.org/Top10/)
- [NIST Cybersecurity Framework](https://www.nist.gov/cyberframework)
- [Next.js Security Best Practices](https://nextjs.org/docs/app/building-your-application/configuring/headers)
- [CWE - Common Weakness Enumeration](https://cwe.mitre.org/)

---

**診断担当者署名**: White Hacker
**所属**: CSIRT Security Assessment Team
**連絡先**: security@organization-unicorn.internal

---
*本レポートは機密情報を含みます。取り扱いには十分ご注意ください。*
