# LifePlan Navigator - ネットワーク・インフラ設計書

**バージョン**: 1.0
**作成日**: 2025-12-11
**分類**: 機密 - 社内限定
**準拠規格**: NIST CSF 2.0, ISO 27001, CIS Controls v8

---

## 1. 概要

### 1.1 設計目的
本ドキュメントは、LifePlan Navigatorのネットワーク・インフラストラクチャのセキュリティ設計を定義します。

### 1.2 設計原則
- **Defense in Depth（多層防御）**: 複数のセキュリティレイヤーによる保護
- **Zero Trust Architecture**: すべてのアクセスを検証、最小権限の原則
- **Fail-Safe Defaults**: デフォルトで安全な設定
- **Economy of Mechanism**: シンプルで監査可能な設計

### 1.3 SLA目標
| 項目 | 目標値 |
|------|--------|
| 可用性 | 99.9% (年間ダウンタイム: 8.76時間以下) |
| RPO (Recovery Point Objective) | 1時間 |
| RTO (Recovery Time Objective) | 4時間 |
| レイテンシ | 国内: 100ms以下 |

---

## 2. ネットワーク構成図

### 2.1 全体構成図

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              INTERNET                                                    │
│                                  │                                                       │
│                      ┌───────────┴───────────┐                                          │
│                      │    DNS (Route 53)     │                                          │
│                      │  ・DNSSEC有効化       │                                          │
│                      │  ・ヘルスチェック連携 │                                          │
│                      └───────────┬───────────┘                                          │
│                                  │                                                       │
│                      ┌───────────┴───────────┐                                          │
│                      │  CloudFront (CDN)     │                                          │
│                      │  ・静的コンテンツ配信 │                                          │
│                      │  ・TLS 1.3終端        │                                          │
│                      │  ・地理的制限         │                                          │
│                      └───────────┬───────────┘                                          │
│                                  │                                                       │
│                      ┌───────────┴───────────┐                                          │
│                      │    AWS WAF            │  ← OWASP CRS, カスタムルール             │
│                      │  ・SQLi検知           │                                          │
│                      │  ・XSS検知            │                                          │
│                      │  ・レートリミット     │                                          │
│                      └───────────┬───────────┘                                          │
│                                  │                                                       │
│                      ┌───────────┴───────────┐                                          │
│                      │  AWS Shield Advanced  │  ← DDoS保護                              │
│                      └───────────┬───────────┘                                          │
└──────────────────────────────────┼──────────────────────────────────────────────────────┘
                                   │
┌──────────────────────────────────┼──────────────────────────────────────────────────────┐
│  VPC: lifeplan-production        │      10.0.0.0/16                                     │
│  ┌───────────────────────────────┼──────────────────────────────────────────────────┐  │
│  │  PUBLIC SUBNET (DMZ)          │      10.0.0.0/20                                  │  │
│  │  AZ-a: 10.0.0.0/22    AZ-c: 10.0.4.0/22    AZ-d: 10.0.8.0/22                    │  │
│  │                               │                                                   │  │
│  │                     ┌─────────┴─────────┐                                        │  │
│  │                     │   Application     │                                        │  │
│  │                     │   Load Balancer   │  ← TLS終端、ヘルスチェック             │  │
│  │                     │   (ALB)           │                                        │  │
│  │                     └─────────┬─────────┘                                        │  │
│  │                               │                                                   │  │
│  │  ┌────────────────────────────┼────────────────────────────────┐                │  │
│  │  │  NAT Gateway (AZ-a)       │  NAT Gateway (AZ-c)            │                │  │
│  │  │  10.0.1.1                  │  10.0.5.1                      │                │  │
│  │  └────────────────────────────┴────────────────────────────────┘                │  │
│  │                                                                                   │  │
│  │  ┌─────────────────────────────────────────────────────────────────────────┐    │  │
│  │  │  Internet Gateway          Bastion Host (EC2)                            │    │  │
│  │  │                            10.0.3.10 (踏み台)                            │    │  │
│  │  └─────────────────────────────────────────────────────────────────────────┘    │  │
│  └───────────────────────────────┬──────────────────────────────────────────────────┘  │
│                                  │                                                      │
│  ┌───────────────────────────────┼──────────────────────────────────────────────────┐  │
│  │  APPLICATION SUBNET           │      10.0.16.0/20                                 │  │
│  │  AZ-a: 10.0.16.0/22   AZ-c: 10.0.20.0/22   AZ-d: 10.0.24.0/22                   │  │
│  │                               │                                                   │  │
│  │  ┌─────────────────┐  ┌──────┴──────┐  ┌─────────────────┐                      │  │
│  │  │  ECS Fargate    │  │ ECS Fargate │  │  ECS Fargate    │                      │  │
│  │  │  (Frontend)     │  │ (Backend)   │  │  (Workers)      │                      │  │
│  │  │  Next.js        │  │ FastAPI     │  │  Celery         │                      │  │
│  │  │                 │  │             │  │                 │                      │  │
│  │  │  Port: 3000     │  │ Port: 8000  │  │  Port: N/A      │                      │  │
│  │  └─────────────────┘  └─────────────┘  └─────────────────┘                      │  │
│  │                                                                                   │  │
│  │  ┌─────────────────────────────────────────────────────────────────────────┐    │  │
│  │  │  ECS Service Connect / App Mesh                                          │    │  │
│  │  │  サービス間通信の暗号化 (mTLS)                                           │    │  │
│  │  └─────────────────────────────────────────────────────────────────────────┘    │  │
│  └───────────────────────────────┬──────────────────────────────────────────────────┘  │
│                                  │                                                      │
│  ┌───────────────────────────────┼──────────────────────────────────────────────────┐  │
│  │  DATA SUBNET (Isolated)       │      10.0.32.0/20                                 │  │
│  │  AZ-a: 10.0.32.0/22   AZ-c: 10.0.36.0/22   AZ-d: 10.0.40.0/22                   │  │
│  │                               │                                                   │  │
│  │  ┌─────────────────┐  ┌──────┴──────┐  ┌─────────────────┐                      │  │
│  │  │  RDS PostgreSQL │  │ ElastiCache │  │  OpenSearch     │                      │  │
│  │  │  (Multi-AZ)     │  │ (Redis)     │  │  Service        │                      │  │
│  │  │                 │  │ Cluster     │  │                 │                      │  │
│  │  │  Port: 5432     │  │ Port: 6379  │  │  Port: 443      │                      │  │
│  │  │  暗号化: 有効   │  │ 暗号化: 有効│  │  暗号化: 有効   │                      │  │
│  │  └─────────────────┘  └─────────────┘  └─────────────────┘                      │  │
│  │                                                                                   │  │
│  │  ※ インターネットへの直接経路なし (VPCエンドポイント経由のみ)                  │  │
│  └───────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                         │
│  ┌───────────────────────────────────────────────────────────────────────────────────┐  │
│  │  MANAGEMENT SUBNET            10.0.48.0/20                                        │  │
│  │  AZ-a: 10.0.48.0/22   AZ-c: 10.0.52.0/22                                         │  │
│  │                                                                                   │  │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐                  │  │
│  │  │  Systems        │  │  CloudWatch     │  │  Secrets        │                  │  │
│  │  │  Manager        │  │  Agent          │  │  Manager        │                  │  │
│  │  │  (SSM)          │  │                 │  │  VPC Endpoint   │                  │  │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘                  │  │
│  └───────────────────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────┐
│  VPC ENDPOINTS (Private Link)                                                            │
│  ┌───────────────┐ ┌───────────────┐ ┌───────────────┐ ┌───────────────┐               │
│  │ S3 Gateway    │ │ ECR (Docker)  │ │ KMS           │ │ CloudWatch    │               │
│  │ Endpoint      │ │ Interface     │ │ Interface     │ │ Logs          │               │
│  └───────────────┘ └───────────────┘ └───────────────┘ └───────────────┘               │
│  ┌───────────────┐ ┌───────────────┐ ┌───────────────┐ ┌───────────────┐               │
│  │ Secrets       │ │ SES           │ │ SNS           │ │ SQS           │               │
│  │ Manager       │ │ Interface     │ │ Interface     │ │ Interface     │               │
│  └───────────────┘ └───────────────┘ └───────────────┘ └───────────────┘               │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 データセンター間接続（DR構成）

```
┌─────────────────────────────────┐         ┌─────────────────────────────────┐
│    PRIMARY REGION (ap-northeast-1)      │    DR REGION (ap-northeast-3)    │
│    Tokyo                        │         │    Osaka                         │
│                                 │         │                                  │
│  ┌───────────────────────────┐ │         │ ┌───────────────────────────┐   │
│  │  VPC: lifeplan-production │ │◄───────►│ │  VPC: lifeplan-dr        │   │
│  │  10.0.0.0/16              │ │  VPC    │ │  10.1.0.0/16             │   │
│  │                           │ │ Peering │ │                          │   │
│  │  ・ECS Services           │ │         │ │  ・ECS Services (Standby)│   │
│  │  ・RDS Primary            │ │         │ │  ・RDS Read Replica      │   │
│  │  ・ElastiCache            │ │         │ │  ・ElastiCache (Standby) │   │
│  └───────────────────────────┘ │         │ └───────────────────────────┘   │
│                                 │         │                                  │
│  ┌───────────────────────────┐ │         │ ┌───────────────────────────┐   │
│  │  S3: lifeplan-assets      │ │◄───────►│ │  S3: lifeplan-assets-dr  │   │
│  │  (Cross-Region Replication)│         │ │  (レプリカ)               │   │
│  └───────────────────────────┘ │         │ └───────────────────────────┘   │
└─────────────────────────────────┘         └─────────────────────────────────┘
                    │                                        │
                    │              Route 53                  │
                    │         (Failover Routing)             │
                    └────────────────┬───────────────────────┘
                                     │
                              ┌──────┴──────┐
                              │   Users     │
                              └─────────────┘
```

---

## 3. ネットワークセグメンテーション

### 3.1 サブネット設計

| サブネット名 | CIDR | AZ | 用途 | インターネットアクセス |
|-------------|------|-----|------|----------------------|
| public-a | 10.0.0.0/22 | ap-northeast-1a | ALB, NAT GW, Bastion | 双方向 |
| public-c | 10.0.4.0/22 | ap-northeast-1c | ALB, NAT GW | 双方向 |
| public-d | 10.0.8.0/22 | ap-northeast-1d | ALB (予備) | 双方向 |
| app-a | 10.0.16.0/22 | ap-northeast-1a | ECS (Frontend/Backend/Worker) | NAT経由のみ |
| app-c | 10.0.20.0/22 | ap-northeast-1c | ECS (Frontend/Backend/Worker) | NAT経由のみ |
| app-d | 10.0.24.0/22 | ap-northeast-1d | ECS (予備) | NAT経由のみ |
| data-a | 10.0.32.0/22 | ap-northeast-1a | RDS, ElastiCache, OpenSearch | なし |
| data-c | 10.0.36.0/22 | ap-northeast-1c | RDS, ElastiCache, OpenSearch | なし |
| data-d | 10.0.40.0/22 | ap-northeast-1d | RDS (予備) | なし |
| mgmt-a | 10.0.48.0/22 | ap-northeast-1a | 管理用 (SSM, 監視) | VPCエンドポイント |
| mgmt-c | 10.0.52.0/22 | ap-northeast-1c | 管理用 (SSM, 監視) | VPCエンドポイント |

### 3.2 ルートテーブル設計

#### Public Subnet ルートテーブル
| Destination | Target | 説明 |
|-------------|--------|------|
| 10.0.0.0/16 | local | VPC内部通信 |
| 0.0.0.0/0 | igw-xxx | インターネットゲートウェイ |

#### Application Subnet ルートテーブル (AZ-a)
| Destination | Target | 説明 |
|-------------|--------|------|
| 10.0.0.0/16 | local | VPC内部通信 |
| 0.0.0.0/0 | nat-gw-a | NAT Gateway (AZ-a) |

#### Data Subnet ルートテーブル
| Destination | Target | 説明 |
|-------------|--------|------|
| 10.0.0.0/16 | local | VPC内部通信のみ |

### 3.3 Network ACL設計

#### Public Subnet NACL
```
Inbound Rules:
┌──────┬──────────┬──────────┬───────────────┬───────────────┬────────┐
│ Rule │ Type     │ Protocol │ Port Range    │ Source        │ Action │
├──────┼──────────┼──────────┼───────────────┼───────────────┼────────┤
│ 100  │ HTTPS    │ TCP      │ 443           │ 0.0.0.0/0     │ ALLOW  │
│ 110  │ HTTP     │ TCP      │ 80            │ 0.0.0.0/0     │ ALLOW  │
│ 120  │ SSH      │ TCP      │ 22            │ 管理者CIDR    │ ALLOW  │
│ 130  │ Ephemeral│ TCP      │ 1024-65535    │ 0.0.0.0/0     │ ALLOW  │
│ *    │ All      │ All      │ All           │ 0.0.0.0/0     │ DENY   │
└──────┴──────────┴──────────┴───────────────┴───────────────┴────────┘

Outbound Rules:
┌──────┬──────────┬──────────┬───────────────┬───────────────┬────────┐
│ Rule │ Type     │ Protocol │ Port Range    │ Destination   │ Action │
├──────┼──────────┼──────────┼───────────────┼───────────────┼────────┤
│ 100  │ All      │ TCP      │ All           │ 0.0.0.0/0     │ ALLOW  │
│ *    │ All      │ All      │ All           │ 0.0.0.0/0     │ DENY   │
└──────┴──────────┴──────────┴───────────────┴───────────────┴────────┘
```

#### Application Subnet NACL
```
Inbound Rules:
┌──────┬──────────┬──────────┬───────────────┬───────────────┬────────┐
│ Rule │ Type     │ Protocol │ Port Range    │ Source        │ Action │
├──────┼──────────┼──────────┼───────────────┼───────────────┼────────┤
│ 100  │ Custom   │ TCP      │ 3000          │ 10.0.0.0/20   │ ALLOW  │
│ 110  │ Custom   │ TCP      │ 8000          │ 10.0.0.0/20   │ ALLOW  │
│ 120  │ Ephemeral│ TCP      │ 1024-65535    │ 0.0.0.0/0     │ ALLOW  │
│ *    │ All      │ All      │ All           │ 0.0.0.0/0     │ DENY   │
└──────┴──────────┴──────────┴───────────────┴───────────────┴────────┘

Outbound Rules:
┌──────┬──────────┬──────────┬───────────────┬───────────────┬────────┐
│ Rule │ Type     │ Protocol │ Port Range    │ Destination   │ Action │
├──────┼──────────┼──────────┼───────────────┼───────────────┼────────┤
│ 100  │ Custom   │ TCP      │ 5432          │ 10.0.32.0/20  │ ALLOW  │
│ 110  │ Custom   │ TCP      │ 6379          │ 10.0.32.0/20  │ ALLOW  │
│ 120  │ Custom   │ TCP      │ 443           │ 10.0.32.0/20  │ ALLOW  │
│ 130  │ HTTPS    │ TCP      │ 443           │ 0.0.0.0/0     │ ALLOW  │
│ 140  │ Ephemeral│ TCP      │ 1024-65535    │ 10.0.0.0/20   │ ALLOW  │
│ *    │ All      │ All      │ All           │ 0.0.0.0/0     │ DENY   │
└──────┴──────────┴──────────┴───────────────┴───────────────┴────────┘
```

#### Data Subnet NACL
```
Inbound Rules:
┌──────┬──────────┬──────────┬───────────────┬───────────────┬────────┐
│ Rule │ Type     │ Protocol │ Port Range    │ Source        │ Action │
├──────┼──────────┼──────────┼───────────────┼───────────────┼────────┤
│ 100  │ PostgreSQL│ TCP     │ 5432          │ 10.0.16.0/20  │ ALLOW  │
│ 110  │ Redis    │ TCP      │ 6379          │ 10.0.16.0/20  │ ALLOW  │
│ 120  │ HTTPS    │ TCP      │ 443           │ 10.0.16.0/20  │ ALLOW  │
│ *    │ All      │ All      │ All           │ 0.0.0.0/0     │ DENY   │
└──────┴──────────┴──────────┴───────────────┴───────────────┴────────┘

Outbound Rules:
┌──────┬──────────┬──────────┬───────────────┬───────────────┬────────┐
│ Rule │ Type     │ Protocol │ Port Range    │ Destination   │ Action │
├──────┼──────────┼──────────┼───────────────┼───────────────┼────────┤
│ 100  │ Ephemeral│ TCP      │ 1024-65535    │ 10.0.16.0/20  │ ALLOW  │
│ *    │ All      │ All      │ All           │ 0.0.0.0/0     │ DENY   │
└──────┴──────────┴──────────┴───────────────┴───────────────┴────────┘
```

---

## 4. ファイアウォールポリシー（セキュリティグループ）

### 4.1 セキュリティグループ一覧

| SG名 | 用途 | 適用先 |
|------|------|--------|
| sg-alb | ALB用 | Application Load Balancer |
| sg-frontend | フロントエンド用 | ECS Frontend Tasks |
| sg-backend | バックエンド用 | ECS Backend Tasks |
| sg-worker | ワーカー用 | ECS Worker Tasks |
| sg-rds | データベース用 | RDS PostgreSQL |
| sg-redis | キャッシュ用 | ElastiCache Redis |
| sg-opensearch | 検索エンジン用 | OpenSearch Service |
| sg-bastion | 踏み台サーバー用 | Bastion EC2 |
| sg-vpce | VPCエンドポイント用 | Interface Endpoints |

### 4.2 セキュリティグループ詳細ルール

#### sg-alb (Application Load Balancer)
```
Inbound Rules:
┌─────────┬──────────┬───────────┬─────────────────────────────────────┐
│ Type    │ Protocol │ Port      │ Source                              │
├─────────┼──────────┼───────────┼─────────────────────────────────────┤
│ HTTPS   │ TCP      │ 443       │ 0.0.0.0/0 (CloudFront経由のみ推奨)  │
│ HTTP    │ TCP      │ 80        │ 0.0.0.0/0 (HTTPS リダイレクト用)    │
└─────────┴──────────┴───────────┴─────────────────────────────────────┘

Outbound Rules:
┌─────────┬──────────┬───────────┬─────────────────────────────────────┐
│ Type    │ Protocol │ Port      │ Destination                         │
├─────────┼──────────┼───────────┼─────────────────────────────────────┤
│ Custom  │ TCP      │ 3000      │ sg-frontend                         │
│ Custom  │ TCP      │ 8000      │ sg-backend                          │
└─────────┴──────────┴───────────┴─────────────────────────────────────┘

※ CloudFront経由のみに制限する場合:
   AWS管理プレフィックスリスト (com.amazonaws.global.cloudfront.origin-facing) を使用
```

#### sg-frontend (Next.js Frontend)
```
Inbound Rules:
┌─────────┬──────────┬───────────┬─────────────────────────────────────┐
│ Type    │ Protocol │ Port      │ Source                              │
├─────────┼──────────┼───────────┼─────────────────────────────────────┤
│ Custom  │ TCP      │ 3000      │ sg-alb                              │
└─────────┴──────────┴───────────┴─────────────────────────────────────┘

Outbound Rules:
┌─────────┬──────────┬───────────┬─────────────────────────────────────┐
│ Type    │ Protocol │ Port      │ Destination                         │
├─────────┼──────────┼───────────┼─────────────────────────────────────┤
│ Custom  │ TCP      │ 8000      │ sg-backend                          │
│ HTTPS   │ TCP      │ 443       │ sg-vpce                             │
│ HTTPS   │ TCP      │ 443       │ 0.0.0.0/0 (外部API用)               │
└─────────┴──────────┴───────────┴─────────────────────────────────────┘
```

#### sg-backend (FastAPI Backend)
```
Inbound Rules:
┌─────────┬──────────┬───────────┬─────────────────────────────────────┐
│ Type    │ Protocol │ Port      │ Source                              │
├─────────┼──────────┼───────────┼─────────────────────────────────────┤
│ Custom  │ TCP      │ 8000      │ sg-alb                              │
│ Custom  │ TCP      │ 8000      │ sg-frontend                         │
└─────────┴──────────┴───────────┴─────────────────────────────────────┘

Outbound Rules:
┌─────────┬──────────┬───────────┬─────────────────────────────────────┐
│ Type    │ Protocol │ Port      │ Destination                         │
├─────────┼──────────┼───────────┼─────────────────────────────────────┤
│ PostgreSQL│ TCP    │ 5432      │ sg-rds                              │
│ Custom  │ TCP      │ 6379      │ sg-redis                            │
│ HTTPS   │ TCP      │ 443       │ sg-opensearch                       │
│ HTTPS   │ TCP      │ 443       │ sg-vpce                             │
│ HTTPS   │ TCP      │ 443       │ 0.0.0.0/0 (外部API用)               │
└─────────┴──────────┴───────────┴─────────────────────────────────────┘
```

#### sg-worker (Celery Workers)
```
Inbound Rules:
┌─────────┬──────────┬───────────┬─────────────────────────────────────┐
│ Type    │ Protocol │ Port      │ Source                              │
├─────────┼──────────┼───────────┼─────────────────────────────────────┤
│ なし    │ -        │ -         │ -                                   │
└─────────┴──────────┴───────────┴─────────────────────────────────────┘

Outbound Rules:
┌─────────┬──────────┬───────────┬─────────────────────────────────────┐
│ Type    │ Protocol │ Port      │ Destination                         │
├─────────┼──────────┼───────────┼─────────────────────────────────────┤
│ PostgreSQL│ TCP    │ 5432      │ sg-rds                              │
│ Custom  │ TCP      │ 6379      │ sg-redis                            │
│ HTTPS   │ TCP      │ 443       │ sg-opensearch                       │
│ HTTPS   │ TCP      │ 443       │ sg-vpce                             │
│ HTTPS   │ TCP      │ 443       │ 0.0.0.0/0 (外部API用)               │
└─────────┴──────────┴───────────┴─────────────────────────────────────┘
```

#### sg-rds (PostgreSQL)
```
Inbound Rules:
┌─────────┬──────────┬───────────┬─────────────────────────────────────┐
│ Type    │ Protocol │ Port      │ Source                              │
├─────────┼──────────┼───────────┼─────────────────────────────────────┤
│ PostgreSQL│ TCP    │ 5432      │ sg-backend                          │
│ PostgreSQL│ TCP    │ 5432      │ sg-worker                           │
│ PostgreSQL│ TCP    │ 5432      │ sg-bastion                          │
└─────────┴──────────┴───────────┴─────────────────────────────────────┘

Outbound Rules:
┌─────────┬──────────┬───────────┬─────────────────────────────────────┐
│ Type    │ Protocol │ Port      │ Destination                         │
├─────────┼──────────┼───────────┼─────────────────────────────────────┤
│ なし    │ -        │ -         │ - (デフォルトでなし)                │
└─────────┴──────────┴───────────┴─────────────────────────────────────┘
```

#### sg-redis (ElastiCache)
```
Inbound Rules:
┌─────────┬──────────┬───────────┬─────────────────────────────────────┐
│ Type    │ Protocol │ Port      │ Source                              │
├─────────┼──────────┼───────────┼─────────────────────────────────────┤
│ Custom  │ TCP      │ 6379      │ sg-backend                          │
│ Custom  │ TCP      │ 6379      │ sg-worker                           │
└─────────┴──────────┴───────────┴─────────────────────────────────────┘

Outbound Rules:
┌─────────┬──────────┬───────────┬─────────────────────────────────────┐
│ Type    │ Protocol │ Port      │ Destination                         │
├─────────┼──────────┼───────────┼─────────────────────────────────────┤
│ なし    │ -        │ -         │ - (デフォルトでなし)                │
└─────────┴──────────┴───────────┴─────────────────────────────────────┘
```

#### sg-opensearch (OpenSearch Service)
```
Inbound Rules:
┌─────────┬──────────┬───────────┬─────────────────────────────────────┐
│ Type    │ Protocol │ Port      │ Source                              │
├─────────┼──────────┼───────────┼─────────────────────────────────────┤
│ HTTPS   │ TCP      │ 443       │ sg-backend                          │
│ HTTPS   │ TCP      │ 443       │ sg-worker                           │
└─────────┴──────────┴───────────┴─────────────────────────────────────┘

Outbound Rules:
┌─────────┬──────────┬───────────┬─────────────────────────────────────┐
│ Type    │ Protocol │ Port      │ Destination                         │
├─────────┼──────────┼───────────┼─────────────────────────────────────┤
│ なし    │ -        │ -         │ - (デフォルトでなし)                │
└─────────┴──────────┴───────────┴─────────────────────────────────────┘
```

#### sg-bastion (踏み台サーバー)
```
Inbound Rules:
┌─────────┬──────────┬───────────┬─────────────────────────────────────┐
│ Type    │ Protocol │ Port      │ Source                              │
├─────────┼──────────┼───────────┼─────────────────────────────────────┤
│ SSH     │ TCP      │ 22        │ 管理者VPN CIDR (例: 203.0.113.0/24) │
└─────────┴──────────┴───────────┴─────────────────────────────────────┘

Outbound Rules:
┌─────────┬──────────┬───────────┬─────────────────────────────────────┐
│ Type    │ Protocol │ Port      │ Destination                         │
├─────────┼──────────┼───────────┼─────────────────────────────────────┤
│ PostgreSQL│ TCP    │ 5432      │ sg-rds                              │
│ Custom  │ TCP      │ 6379      │ sg-redis                            │
│ HTTPS   │ TCP      │ 443       │ 0.0.0.0/0 (パッケージ更新用)        │
└─────────┴──────────┴───────────┴─────────────────────────────────────┘
```

### 4.3 ファイアウォールポリシーマトリクス

```
                    ┌─────┬─────────┬─────────┬────────┬─────┬───────┬──────────┬─────────┬─────────┐
                    │ ALB │Frontend │ Backend │ Worker │ RDS │ Redis │OpenSearch│ Bastion │Internet │
┌───────────────────┼─────┼─────────┼─────────┼────────┼─────┼───────┼──────────┼─────────┼─────────┤
│ ALB               │  -  │  3000   │  8000   │   -    │  -  │   -   │    -     │    -    │   443   │
├───────────────────┼─────┼─────────┼─────────┼────────┼─────┼───────┼──────────┼─────────┼─────────┤
│ Frontend          │  -  │    -    │  8000   │   -    │  -  │   -   │    -     │    -    │   443   │
├───────────────────┼─────┼─────────┼─────────┼────────┼─────┼───────┼──────────┼─────────┼─────────┤
│ Backend           │  -  │    -    │    -    │   -    │5432 │ 6379  │   443    │    -    │   443   │
├───────────────────┼─────┼─────────┼─────────┼────────┼─────┼───────┼──────────┼─────────┼─────────┤
│ Worker            │  -  │    -    │    -    │   -    │5432 │ 6379  │   443    │    -    │   443   │
├───────────────────┼─────┼─────────┼─────────┼────────┼─────┼───────┼──────────┼─────────┼─────────┤
│ RDS               │  -  │    -    │    -    │   -    │  -  │   -   │    -     │    -    │    -    │
├───────────────────┼─────┼─────────┼─────────┼────────┼─────┼───────┼──────────┼─────────┼─────────┤
│ Redis             │  -  │    -    │    -    │   -    │  -  │   -   │    -     │    -    │    -    │
├───────────────────┼─────┼─────────┼─────────┼────────┼─────┼───────┼──────────┼─────────┼─────────┤
│ OpenSearch        │  -  │    -    │    -    │   -    │  -  │   -   │    -     │    -    │    -    │
├───────────────────┼─────┼─────────┼─────────┼────────┼─────┼───────┼──────────┼─────────┼─────────┤
│ Bastion           │  -  │    -    │    -    │   -    │5432 │ 6379  │    -     │    -    │   443   │
├───────────────────┼─────┼─────────┼─────────┼────────┼─────┼───────┼──────────┼─────────┼─────────┤
│ Internet          │ 443 │    -    │    -    │   -    │  -  │   -   │    -     │   22*   │    -    │
└───────────────────┴─────┴─────────┴─────────┴────────┴─────┴───────┴──────────┴─────────┴─────────┘

* 管理者VPN CIDRからのみ許可
- : 通信不可
数字: 許可されるポート番号
```

---

## 5. WAF・DDoS対策・CDN設計

### 5.1 AWS WAF設計

#### 5.1.1 WAFアーキテクチャ
```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              AWS WAF Configuration                               │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  Web ACL: lifeplan-production-waf                                        │   │
│  │  Scope: CLOUDFRONT                                                       │   │
│  │  Default Action: ALLOW                                                   │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  Rule Priority Order (数字が小さいほど高優先)                           │   │
│  │                                                                          │   │
│  │  Priority 0: IP Blocklist (カスタムルール)                              │   │
│  │    → 既知の悪意あるIPをブロック                                         │   │
│  │                                                                          │   │
│  │  Priority 1: AWS-AWSManagedRulesAmazonIpReputationList                  │   │
│  │    → Amazon脅威インテリジェンスに基づくIPブロック                       │   │
│  │                                                                          │   │
│  │  Priority 2: AWS-AWSManagedRulesCommonRuleSet (CRS)                     │   │
│  │    → OWASP Top 10対策                                                   │   │
│  │                                                                          │   │
│  │  Priority 3: AWS-AWSManagedRulesKnownBadInputsRuleSet                   │   │
│  │    → Log4Shell等の既知の攻撃パターン                                    │   │
│  │                                                                          │   │
│  │  Priority 4: AWS-AWSManagedRulesSQLiRuleSet                             │   │
│  │    → SQLインジェクション対策                                            │   │
│  │                                                                          │   │
│  │  Priority 5: Rate Limit Rule (カスタムルール)                           │   │
│  │    → レートリミット: 2000 req/5min/IP                                   │   │
│  │                                                                          │   │
│  │  Priority 6: Geo Restriction (カスタムルール)                           │   │
│  │    → 日本国外からのアクセス制限（オプション）                           │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

#### 5.1.2 WAFルール詳細

| ルール名 | 種類 | アクション | 説明 |
|----------|------|------------|------|
| IP-Blocklist | カスタム | Block | 脅威インテリジェンスで特定された悪意あるIP |
| AWSManagedRulesAmazonIpReputationList | マネージド | Block | ボット、TOR出口ノード等 |
| AWSManagedRulesCommonRuleSet | マネージド | Block | サイズ制限、クロスサイトスクリプティング等 |
| AWSManagedRulesKnownBadInputsRuleSet | マネージド | Block | Log4Shell、Spring4Shell等 |
| AWSManagedRulesSQLiRuleSet | マネージド | Block | SQLインジェクションパターン |
| Rate-Limit-Per-IP | カスタム | Block | 2000リクエスト/5分/IP超過時 |
| Geo-Restriction | カスタム | Block | 日本(JP)以外からのアクセス（オプション） |

#### 5.1.3 カスタムルール設定例

```json
{
  "Name": "RateLimitPerIP",
  "Priority": 5,
  "Statement": {
    "RateBasedStatement": {
      "Limit": 2000,
      "AggregateKeyType": "IP"
    }
  },
  "Action": {
    "Block": {
      "CustomResponse": {
        "ResponseCode": 429,
        "CustomResponseBodyKey": "rate-limit-exceeded"
      }
    }
  },
  "VisibilityConfig": {
    "SampledRequestsEnabled": true,
    "CloudWatchMetricsEnabled": true,
    "MetricName": "RateLimitPerIP"
  }
}
```

#### 5.1.4 APIエンドポイント別レートリミット

| エンドポイント | レートリミット | 理由 |
|---------------|---------------|------|
| /api/auth/login | 5 req/min/IP | ブルートフォース対策 |
| /api/auth/register | 3 req/hour/IP | アカウント作成制限 |
| /api/auth/password-reset | 3 req/hour/IP | パスワードリセット制限 |
| /api/simulation/* | 10 req/min/user | リソース集約型API |
| /api/* (その他) | 100 req/min/IP | 一般的なAPI |

### 5.2 DDoS対策

#### 5.2.1 AWS Shield Advanced
```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           AWS Shield Advanced                                    │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  Protected Resources:                                                            │
│  ├── CloudFront Distribution: lifeplan-production                               │
│  ├── Application Load Balancer: lifeplan-alb                                    │
│  ├── Route 53 Hosted Zone: lifeplan-navigator.example.com                       │
│  └── Elastic IP (NAT Gateway): eip-nat-a, eip-nat-c                            │
│                                                                                  │
│  Features:                                                                       │
│  ├── Layer 3/4 DDoS Protection (自動)                                          │
│  ├── Layer 7 DDoS Protection (WAF連携)                                         │
│  ├── 24/7 DDoS Response Team (DRT) アクセス                                    │
│  ├── 攻撃中のコスト保護                                                        │
│  └── リアルタイム攻撃可視化                                                    │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

#### 5.2.2 DDoS緩和戦略

| レイヤー | 脅威 | 対策 |
|---------|------|------|
| Layer 3/4 | UDP Flood, SYN Flood | Shield Standard/Advanced自動緩和 |
| Layer 7 | HTTP Flood | WAFレートリミット、CloudFrontキャッシュ |
| DNS | DNS Amplification | Route 53 Anycast、Shield保護 |
| Application | Slowloris, R.U.D.Y. | ALBタイムアウト設定、接続数制限 |

### 5.3 CDN設計 (CloudFront)

#### 5.3.1 CloudFront構成
```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                         CloudFront Distribution                                  │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  Distribution ID: EXAMPLEID12345                                                │
│  Domain: cdn.lifeplan-navigator.example.com                                     │
│  Alternate Domain: lifeplan-navigator.example.com                               │
│  Price Class: PriceClass_200 (Asia, Europe, NA)                                 │
│                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  Origins                                                                 │   │
│  │                                                                          │   │
│  │  Origin 1: S3 (Static Assets)                                           │   │
│  │    Domain: lifeplan-assets.s3.ap-northeast-1.amazonaws.com              │   │
│  │    Path Pattern: /static/*, /assets/*, /_next/static/*                  │   │
│  │    OAI: Origin Access Identity有効                                      │   │
│  │    Cache Policy: CachingOptimized (TTL: 1年)                            │   │
│  │                                                                          │   │
│  │  Origin 2: ALB (Dynamic Content)                                        │   │
│  │    Domain: lifeplan-alb.ap-northeast-1.elb.amazonaws.com               │   │
│  │    Path Pattern: /*, /api/*                                             │   │
│  │    Cache Policy: CachingDisabled                                        │   │
│  │    Origin Request Policy: AllViewer                                     │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  Behaviors                                                               │   │
│  │                                                                          │   │
│  │  Behavior 1: /static/*                                                  │   │
│  │    Origin: S3                                                           │   │
│  │    Viewer Protocol: HTTPS Only                                          │   │
│  │    Cache: Enabled (86400s)                                              │   │
│  │    Compress: Yes (gzip, br)                                             │   │
│  │                                                                          │   │
│  │  Behavior 2: /_next/static/*                                            │   │
│  │    Origin: S3                                                           │   │
│  │    Viewer Protocol: HTTPS Only                                          │   │
│  │    Cache: Enabled (31536000s, immutable)                                │   │
│  │    Compress: Yes                                                        │   │
│  │                                                                          │   │
│  │  Behavior 3: /api/*                                                     │   │
│  │    Origin: ALB                                                          │   │
│  │    Viewer Protocol: HTTPS Only                                          │   │
│  │    Cache: Disabled                                                      │   │
│  │    Origin Request Policy: AllViewer                                     │   │
│  │                                                                          │   │
│  │  Behavior 4: /* (Default)                                               │   │
│  │    Origin: ALB                                                          │   │
│  │    Viewer Protocol: Redirect HTTP to HTTPS                              │   │
│  │    Cache: Disabled (Dynamic HTML)                                       │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  Security Settings                                                       │   │
│  │                                                                          │   │
│  │  SSL Certificate: ACM (*.lifeplan-navigator.example.com)                │   │
│  │  Minimum Protocol Version: TLSv1.2_2021                                 │   │
│  │  Security Policy: TLSv1.2_2021                                          │   │
│  │  WAF Web ACL: lifeplan-production-waf                                   │   │
│  │  Field-Level Encryption: N/A                                            │   │
│  │  Response Headers Policy: SecurityHeadersPolicy                         │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

#### 5.3.2 セキュリティヘッダーポリシー

```
Response Headers Policy: lifeplan-security-headers

Headers:
├── Strict-Transport-Security: max-age=31536000; includeSubDomains; preload
├── X-Content-Type-Options: nosniff
├── X-Frame-Options: DENY
├── X-XSS-Protection: 1; mode=block
├── Referrer-Policy: strict-origin-when-cross-origin
├── Content-Security-Policy: default-src 'self'; script-src 'self' 'nonce-{random}'; ...
└── Permissions-Policy: geolocation=(), microphone=(), camera=()
```

---

## 6. 可用性設計

### 6.1 負荷分散設計

#### 6.1.1 Application Load Balancer構成
```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                      Application Load Balancer                                   │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  ALB Name: lifeplan-alb                                                         │
│  Scheme: internet-facing                                                        │
│  IP Address Type: dualstack (IPv4 + IPv6)                                       │
│  Subnets: public-a, public-c, public-d (3-AZ)                                   │
│                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  Listeners                                                               │   │
│  │                                                                          │   │
│  │  HTTPS:443                                                              │   │
│  │    Certificate: ACM (lifeplan-navigator.example.com)                    │   │
│  │    Security Policy: ELBSecurityPolicy-TLS13-1-2-2021-06                 │   │
│  │    Default Action: Forward to target group                              │   │
│  │                                                                          │   │
│  │    Rules:                                                               │   │
│  │    ├── Path: /api/* → tg-backend (8000)                                │   │
│  │    ├── Path: /health → Fixed Response 200                              │   │
│  │    └── Path: /* → tg-frontend (3000)                                   │   │
│  │                                                                          │   │
│  │  HTTP:80                                                                │   │
│  │    Default Action: Redirect to HTTPS (301)                              │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  Target Groups                                                           │   │
│  │                                                                          │   │
│  │  tg-frontend:                                                           │   │
│  │    Port: 3000                                                           │   │
│  │    Protocol: HTTP                                                       │   │
│  │    Target Type: ip (Fargate)                                            │   │
│  │    Health Check: /health (HTTP 200)                                     │   │
│  │    Deregistration Delay: 30s                                            │   │
│  │    Stickiness: Disabled                                                 │   │
│  │                                                                          │   │
│  │  tg-backend:                                                            │   │
│  │    Port: 8000                                                           │   │
│  │    Protocol: HTTP                                                       │   │
│  │    Target Type: ip (Fargate)                                            │   │
│  │    Health Check: /api/health (HTTP 200)                                 │   │
│  │    Deregistration Delay: 30s                                            │   │
│  │    Stickiness: Disabled                                                 │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  Connection Settings                                                     │   │
│  │                                                                          │   │
│  │  Idle Timeout: 60 seconds                                               │   │
│  │  HTTP/2: Enabled                                                        │   │
│  │  Drop Invalid Header Fields: Enabled                                    │   │
│  │  Desync Mitigation Mode: Defensive                                      │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

#### 6.1.2 ECS Auto Scaling設定

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                         ECS Service Auto Scaling                                 │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  Service: lifeplan-frontend                                                     │
│  ├── Min Tasks: 2                                                               │
│  ├── Max Tasks: 10                                                              │
│  ├── Desired Tasks: 2                                                           │
│  └── Scaling Policies:                                                          │
│      ├── Target Tracking: CPU Utilization 70%                                   │
│      └── Target Tracking: Memory Utilization 80%                                │
│                                                                                  │
│  Service: lifeplan-backend                                                      │
│  ├── Min Tasks: 2                                                               │
│  ├── Max Tasks: 20                                                              │
│  ├── Desired Tasks: 3                                                           │
│  └── Scaling Policies:                                                          │
│      ├── Target Tracking: CPU Utilization 70%                                   │
│      ├── Target Tracking: Request Count Per Target 1000                         │
│      └── Step Scaling: ALB 5xx Error Rate > 5%                                  │
│                                                                                  │
│  Service: lifeplan-worker                                                       │
│  ├── Min Tasks: 1                                                               │
│  ├── Max Tasks: 10                                                              │
│  ├── Desired Tasks: 2                                                           │
│  └── Scaling Policies:                                                          │
│      └── Target Tracking: SQS ApproximateNumberOfMessagesVisible / Tasks < 100  │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 6.2 フェイルオーバー設計

#### 6.2.1 Multi-AZ構成
```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              Multi-AZ Architecture                               │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│        AZ-a (ap-northeast-1a)        AZ-c (ap-northeast-1c)                    │
│  ┌─────────────────────────┐   ┌─────────────────────────┐                     │
│  │     ALB Node            │   │     ALB Node            │                     │
│  │  ┌───────────────────┐  │   │  ┌───────────────────┐  │                     │
│  │  │ ECS Tasks         │  │   │  │ ECS Tasks         │  │                     │
│  │  │ ├── Frontend x1   │  │   │  │ ├── Frontend x1   │  │                     │
│  │  │ ├── Backend x2    │  │   │  │ ├── Backend x2    │  │                     │
│  │  │ └── Worker x1     │  │   │  │ └── Worker x1     │  │                     │
│  │  └───────────────────┘  │   │  └───────────────────┘  │                     │
│  │  ┌───────────────────┐  │   │  ┌───────────────────┐  │                     │
│  │  │ RDS (Primary)     │◄─┼───┼──│ RDS (Standby)     │  │                     │
│  │  │ PostgreSQL        │  │   │  │ Synchronous Rep   │  │                     │
│  │  └───────────────────┘  │   │  └───────────────────┘  │                     │
│  │  ┌───────────────────┐  │   │  ┌───────────────────┐  │                     │
│  │  │ ElastiCache       │◄─┼───┼──│ ElastiCache       │  │                     │
│  │  │ Primary Node      │  │   │  │ Replica Node      │  │                     │
│  │  └───────────────────┘  │   │  └───────────────────┘  │                     │
│  └─────────────────────────┘   └─────────────────────────┘                     │
│                                                                                  │
│  Failover Time:                                                                 │
│  ├── ECS Tasks: ~30 seconds (health check + replacement)                        │
│  ├── RDS Failover: ~60-120 seconds (automatic)                                  │
│  └── ElastiCache Failover: ~60 seconds (automatic)                             │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

#### 6.2.2 Route 53 ヘルスチェック

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          Route 53 Health Checks                                  │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  Health Check 1: Primary Region (Tokyo)                                         │
│  ├── Type: HTTPS                                                                │
│  ├── Endpoint: https://lifeplan-navigator.example.com/health                   │
│  ├── Request Interval: 10 seconds                                               │
│  ├── Failure Threshold: 3                                                       │
│  ├── Regions: 3 (US East, EU West, AP Southeast)                               │
│  └── Alarm: SNS → PagerDuty                                                    │
│                                                                                  │
│  Health Check 2: DR Region (Osaka)                                              │
│  ├── Type: HTTPS                                                                │
│  ├── Endpoint: https://dr.lifeplan-navigator.example.com/health                │
│  ├── Request Interval: 30 seconds                                               │
│  ├── Failure Threshold: 3                                                       │
│  └── Alarm: SNS → PagerDuty                                                    │
│                                                                                  │
│  Routing Policy: Failover                                                       │
│  ├── Primary: Tokyo (Weight: 100, Health Check: Required)                      │
│  └── Secondary: Osaka (Weight: 0, Health Check: Required)                      │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 6.3 バックアップ・DR設計

#### 6.3.1 バックアップ戦略
```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            Backup Strategy                                       │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  RDS PostgreSQL:                                                                │
│  ├── Automated Backups: 有効                                                    │
│  │   ├── Backup Window: 17:00-18:00 UTC (02:00-03:00 JST)                      │
│  │   ├── Retention Period: 35 days                                              │
│  │   └── Encryption: AWS KMS (aws/rds)                                         │
│  ├── Manual Snapshots: 週次 (日曜 03:00 JST)                                   │
│  │   └── Retention: 1 year                                                      │
│  ├── Cross-Region Replication: 有効                                            │
│  │   └── Destination: ap-northeast-3 (Osaka)                                   │
│  └── Point-in-Time Recovery: 有効                                              │
│      └── Retention: 35 days                                                     │
│                                                                                  │
│  ElastiCache Redis:                                                             │
│  ├── Automatic Backups: 有効                                                    │
│  │   ├── Backup Window: 18:00-19:00 UTC                                        │
│  │   ├── Retention Period: 7 days                                              │
│  │   └── Snapshot: RDB形式                                                     │
│  └── Manual Snapshots: 必要時のみ                                              │
│                                                                                  │
│  S3:                                                                            │
│  ├── Versioning: 有効                                                          │
│  │   └── Lifecycle: 90日後にGlacierへ移行、365日後に削除                       │
│  ├── Cross-Region Replication: 有効                                            │
│  │   └── Destination: ap-northeast-3 (Osaka)                                   │
│  └── Object Lock: Governance Mode (監査ログバケットのみ)                       │
│                                                                                  │
│  OpenSearch:                                                                    │
│  ├── Automated Snapshots: 有効 (毎日)                                          │
│  ├── Retention: 14 days                                                         │
│  └── Manual Snapshots: S3へ週次バックアップ                                    │
│                                                                                  │
│  ECS/Fargate:                                                                   │
│  └── Task Definition: Infrastructure as Code (Terraform)                        │
│      └── Version Control: Git                                                   │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

#### 6.3.2 DR手順（RTO: 4時間, RPO: 1時間）

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          Disaster Recovery Procedure                             │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  Phase 1: 検知・判断 (0-15分)                                                   │
│  ├── Step 1: アラート受信・確認                                                │
│  ├── Step 2: Primary Regionの状態確認                                          │
│  ├── Step 3: DR発動判断（CSIRT Team Leader承認）                               │
│  └── Step 4: ステークホルダーへの初期通知                                      │
│                                                                                  │
│  Phase 2: DR環境準備 (15分-1時間)                                               │
│  ├── Step 5: RDS Read ReplicaをPrimaryに昇格                                   │
│  │   └── aws rds promote-read-replica --db-instance-identifier lifeplan-dr     │
│  ├── Step 6: ElastiCache Replicaをフェイルオーバー                             │
│  ├── Step 7: ECS Servicesのスケールアップ (Osaka)                              │
│  │   └── Min/Desired Tasksを本番設定に変更                                     │
│  └── Step 8: 環境変数・シークレットの確認                                      │
│                                                                                  │
│  Phase 3: トラフィック切り替え (1時間-2時間)                                    │
│  ├── Step 9: Route 53 Failover実行                                             │
│  │   └── Primary → Secondary への手動切り替え                                  │
│  ├── Step 10: CloudFront Originの更新                                          │
│  ├── Step 11: WAF設定の確認                                                    │
│  └── Step 12: スモークテスト実行                                               │
│                                                                                  │
│  Phase 4: 検証・安定化 (2時間-4時間)                                            │
│  ├── Step 13: 主要機能の動作確認                                               │
│  │   ├── ログイン/ログアウト                                                   │
│  │   ├── データ参照/更新                                                       │
│  │   └── シミュレーション実行                                                  │
│  ├── Step 14: パフォーマンス監視                                               │
│  ├── Step 15: エラーログ監視                                                   │
│  └── Step 16: ステークホルダーへの復旧完了通知                                 │
│                                                                                  │
│  Phase 5: フォールバック準備                                                    │
│  ├── Step 17: Primary Regionの復旧状況監視                                     │
│  ├── Step 18: データ同期状態の確認                                             │
│  └── Step 19: フォールバック計画の策定                                         │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 7. 監視・ログ設計

### 7.1 監視アーキテクチャ

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          Monitoring Architecture                                 │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  ┌────────────────────────────────────────────────────────────────────────────┐│
│  │                         Data Sources                                        ││
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐        ││
│  │  │ CloudFront│ │   ALB   │ │   ECS   │ │   RDS   │ │   WAF   │        ││
│  │  │  Logs    │ │  Logs   │ │  Logs   │ │  Logs   │ │  Logs   │        ││
│  │  └────┬─────┘ └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘        ││
│  │       │            │           │           │           │              ││
│  └───────┼────────────┼───────────┼───────────┼───────────┼──────────────┘│
│          │            │           │           │           │                │
│          └────────────┴───────────┴─────┬─────┴───────────┘                │
│                                         │                                   │
│  ┌──────────────────────────────────────┼───────────────────────────────────┐│
│  │                    CloudWatch Logs   │                                   ││
│  │                         ┌────────────┴────────────┐                     ││
│  │                         │     Log Groups          │                     ││
│  │                         │  ├── /aws/cloudfront    │                     ││
│  │                         │  ├── /aws/alb           │                     ││
│  │                         │  ├── /aws/ecs/frontend  │                     ││
│  │                         │  ├── /aws/ecs/backend   │                     ││
│  │                         │  ├── /aws/rds           │                     ││
│  │                         │  └── /aws/waf           │                     ││
│  │                         └────────────┬────────────┘                     ││
│  └──────────────────────────────────────┼───────────────────────────────────┘│
│                                         │                                    │
│          ┌──────────────────────────────┼──────────────────────────────┐    │
│          │                              │                              │    │
│          ▼                              ▼                              ▼    │
│  ┌───────────────┐            ┌───────────────┐            ┌───────────────┐│
│  │  CloudWatch   │            │   OpenSearch  │            │   S3 (Long    │││
│  │   Metrics     │            │  (SIEM/分析)  │            │    Term)      │││
│  │   Alarms      │            │               │            │               │││
│  └───────┬───────┘            └───────┬───────┘            └───────────────┘│
│          │                            │                                      │
│          └────────────┬───────────────┘                                      │
│                       │                                                      │
│                       ▼                                                      │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │                         Alerting                                        │ │
│  │  ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐         │ │
│  │  │   SNS    │───►│PagerDuty │───►│  Slack   │───►│  Email   │         │ │
│  │  └──────────┘    └──────────┘    └──────────┘    └──────────┘         │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 7.2 メトリクス監視

#### 7.2.1 インフラメトリクス

| メトリクス | しきい値 | アラート条件 | 対応 |
|-----------|----------|--------------|------|
| ALB 5XX Error Rate | > 1% | 5分間平均 | P1 エスカレーション |
| ALB Response Time | > 500ms | p99, 5分間 | 調査開始 |
| ALB Active Connections | > 10,000 | 瞬間値 | スケールアウト検討 |
| ECS CPU Utilization | > 80% | 5分間平均 | Auto Scaling発動 |
| ECS Memory Utilization | > 85% | 5分間平均 | Auto Scaling発動 |
| RDS CPU Utilization | > 70% | 10分間平均 | 調査・最適化 |
| RDS Free Storage | < 20% | 瞬間値 | ストレージ拡張 |
| RDS Read Replica Lag | > 60s | 5分間平均 | 調査・対応 |
| ElastiCache CPU | > 70% | 5分間平均 | スケールアップ検討 |
| ElastiCache Memory | > 80% | 瞬間値 | キー削除/スケールアップ |

#### 7.2.2 アプリケーションメトリクス

| メトリクス | しきい値 | アラート条件 | 対応 |
|-----------|----------|--------------|------|
| API Response Time (p95) | > 200ms | 5分間 | パフォーマンス調査 |
| API Error Rate | > 0.1% | 5分間平均 | 調査開始 |
| Login Success Rate | < 98% | 15分間平均 | セキュリティ調査 |
| DB Query Time (p95) | > 100ms | 5分間 | クエリ最適化 |
| Cache Hit Rate | < 80% | 1時間平均 | キャッシュ戦略見直し |
| Background Job Latency | > 300s | 5分間平均 | Worker スケールアウト |

### 7.3 セキュリティ監視

#### 7.3.1 セキュリティアラート

| イベント | 検知方法 | 優先度 | 対応 |
|----------|----------|--------|------|
| WAF ブロック急増 | CloudWatch | P1 | 攻撃分析・対応 |
| 異常なログイン試行 | アプリログ分析 | P1 | アカウント保護 |
| 管理者権限昇格 | CloudTrail | P1 | 即時調査 |
| データベース大量クエリ | RDS Performance Insights | P2 | 調査 |
| 新規 IAM ユーザー作成 | CloudTrail | P2 | 承認確認 |
| セキュリティグループ変更 | CloudTrail | P2 | 変更内容確認 |
| 深夜時間帯のアクセス | VPC Flow Logs | P3 | 翌営業日確認 |

#### 7.3.2 VPC Flow Logs分析

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          VPC Flow Logs Analysis                                  │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  Flow Log Settings:                                                             │
│  ├── Traffic Type: ALL (ACCEPT + REJECT)                                        │
│  ├── Destination: CloudWatch Logs + S3                                          │
│  ├── Log Format: Custom (全フィールド)                                          │
│  └── Aggregation Interval: 1 minute                                             │
│                                                                                  │
│  Analysis Rules:                                                                │
│  ├── Rule 1: 異常なポートスキャン検知                                          │
│  │   └── 1分間に50以上のREJECTされた接続 → Alert                               │
│  ├── Rule 2: 内部通信の異常検知                                                │
│  │   └── Data SubnetからのInternet向け通信 → Critical Alert                    │
│  ├── Rule 3: 大量データ転送検知                                                │
│  │   └── 1時間で10GB以上の外向き通信 → Investigation                          │
│  └── Rule 4: 未許可IP検知                                                      │
│      └── 許可リスト外IPからの管理ポートアクセス → Alert                        │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 7.4 ログ管理

#### 7.4.1 ログ保持ポリシー

| ログ種別 | CloudWatch保持 | S3保持 | Glacier | 完全削除 |
|----------|---------------|--------|---------|----------|
| アプリケーションログ | 30日 | 90日 | 1年 | 3年 |
| アクセスログ (ALB) | 30日 | 90日 | 1年 | 3年 |
| WAFログ | 30日 | 90日 | 2年 | 5年 |
| VPC Flow Logs | 14日 | 90日 | 1年 | 3年 |
| CloudTrail | 90日 | 1年 | 7年 | 無期限 |
| 認証ログ | 90日 | 1年 | 2年 | 7年 |
| 監査ログ | 90日 | 1年 | 7年 | 無期限 |

#### 7.4.2 ログフォーマット（構造化ログ）

```json
{
  "timestamp": "2025-12-11T10:30:00.123Z",
  "level": "INFO",
  "service": "lifeplan-backend",
  "traceId": "1-5f84c7a2-aaaaaa",
  "spanId": "bbbbbbb",
  "userId": "usr_xxxx****",
  "action": "user.login",
  "status": "success",
  "duration_ms": 145,
  "ip": "203.0.113.xxx",
  "userAgent": "Mozilla/5.0...",
  "metadata": {
    "mfa_used": true,
    "session_id": "sess_xxxx****"
  }
}
```

---

## 8. 運用要件

### 8.1 セキュリティパッチ管理

| 対象 | パッチ適用頻度 | 適用方法 | ダウンタイム |
|------|---------------|----------|-------------|
| ECS Container Images | 週次 | Blue/Green Deploy | なし |
| RDS PostgreSQL | 月次 | メンテナンスウィンドウ | ~10分 |
| ElastiCache | 月次 | Rolling Update | なし |
| OS (Fargate) | 自動 | AWS管理 | なし |
| WAF Rules | 自動 | マネージドルール自動更新 | なし |

### 8.2 定期メンテナンス

| 作業 | 頻度 | 担当 | 作業内容 |
|------|------|------|----------|
| セキュリティグループレビュー | 月次 | Network Engineer | 不要ルールの削除 |
| IAMポリシーレビュー | 四半期 | Security Team | 最小権限の確認 |
| 脆弱性スキャン | 週次 | SOC Analyst | Inspector実行 |
| ペネトレーションテスト | 年次 | White Hacker | 外部診断 |
| DR訓練 | 四半期 | CSIRT Team | フェイルオーバーテスト |
| バックアップリストアテスト | 四半期 | DevOps | RDS/S3リストア検証 |

### 8.3 変更管理

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          Change Management Process                               │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  Standard Change (Low Risk):                                                    │
│  ├── 例: セキュリティグループの既存ルール修正                                  │
│  ├── 承認: 担当者のみ                                                          │
│  └── 実施: いつでも可                                                          │
│                                                                                  │
│  Normal Change (Medium Risk):                                                   │
│  ├── 例: 新規セキュリティグループ追加、WAFルール変更                           │
│  ├── 承認: チームリーダー + セキュリティレビュー                               │
│  └── 実施: 計画されたメンテナンスウィンドウ                                    │
│                                                                                  │
│  Emergency Change (High Risk):                                                  │
│  ├── 例: セキュリティインシデント対応                                          │
│  ├── 承認: CISO承認（事後報告可）                                              │
│  └── 実施: 即時                                                                │
│                                                                                  │
│  Change Advisory Board (CAB):                                                   │
│  ├── 参加者: CTO, CISO, CSIRT Leader, Network Engineer                         │
│  ├── 開催: 週次（木曜 15:00 JST）                                              │
│  └── 議題: 翌週の変更レビュー・承認                                            │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 9. コスト最適化

### 9.1 推定月額コスト

| サービス | 構成 | 月額コスト (USD) |
|----------|------|-----------------|
| ECS Fargate | Frontend 2-10 tasks, Backend 2-20 tasks, Worker 1-10 tasks | $800 - $2,500 |
| RDS PostgreSQL | db.r6g.large, Multi-AZ, 200GB | $600 |
| ElastiCache Redis | cache.r6g.large, 2 nodes | $400 |
| OpenSearch | 2x t3.medium.search | $200 |
| CloudFront | 1TB/月転送 | $100 |
| ALB | 1 ALB + LCU | $50 |
| NAT Gateway | 2 NAT GW, 100GB/月 | $100 |
| WAF | Web ACL + Managed Rules | $50 |
| Shield Advanced | - | $3,000 |
| Route 53 | Hosted Zone + Health Checks | $10 |
| S3 | 500GB + Cross-Region Replication | $30 |
| CloudWatch | Logs + Metrics + Alarms | $100 |
| Secrets Manager | 20 secrets | $10 |
| **合計（通常時）** | | **$5,450 - $7,150** |

### 9.2 コスト削減オプション

| 項目 | 削減策 | 削減額 |
|------|--------|--------|
| Reserved Instances | RDS/ElastiCache 1年予約 | -30% |
| Savings Plans | ECS Fargate Compute | -20% |
| Shield Standard | Shield Advanced → Standard（DRT不要の場合） | -$3,000 |
| スポットインスタンス | Worker タスク（中断許容） | -60% |

---

## 10. 付録

### 10.1 Terraform モジュール構成

```
terraform/
├── environments/
│   ├── production/
│   │   ├── main.tf
│   │   ├── variables.tf
│   │   └── terraform.tfvars
│   └── dr/
│       ├── main.tf
│       └── variables.tf
├── modules/
│   ├── vpc/
│   ├── security-groups/
│   ├── alb/
│   ├── ecs/
│   ├── rds/
│   ├── elasticache/
│   ├── waf/
│   ├── cloudfront/
│   └── monitoring/
└── README.md
```

### 10.2 関連ドキュメント

- システムアーキテクチャ設計書: `01_system_architecture.md`
- 技術スタック定義書: `02_tech_stack.md`
- API仕様書: `03_api_specification.md`
- データベース設計書: `04_database_design.md`
- セキュリティ要件定義書: `LifePlan_Navigator_Security_Requirements.md`

---

## 11. 改訂履歴

| バージョン | 日付 | 変更内容 | 承認者 |
|-----------|------|----------|--------|
| 1.0 | 2025-12-11 | 初版作成 | Network Engineer |

---

**承認**

| 役職 | 氏名 | 署名 | 日付 |
|------|------|------|------|
| CTO | | | |
| CISO | | | |
| Network Engineer | | | |
