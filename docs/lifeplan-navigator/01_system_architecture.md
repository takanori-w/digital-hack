# LifePlan Navigator - システムアーキテクチャ設計書

## 1. システム構成図

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              LifePlan Navigator                                  │
│                           System Architecture v1.0                               │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│                              CLIENT LAYER                                        │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                      Next.js Frontend (React 18)                         │   │
│  │  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐   │   │
│  │  │  Dashboard   │ │  LifeStage   │ │  Subsidy     │ │ Simulation   │   │   │
│  │  │    Page      │ │   Manager    │ │   Search     │ │   Engine     │   │   │
│  │  └──────────────┘ └──────────────┘ └──────────────┘ └──────────────┘   │   │
│  │  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐                     │   │
│  │  │   Profile    │ │ Notification │ │    Auth      │                     │   │
│  │  │   Settings   │ │    Center    │ │   (NextAuth) │                     │   │
│  │  └──────────────┘ └──────────────┘ └──────────────┘                     │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                      │                                          │
│                              HTTPS / WebSocket                                   │
└──────────────────────────────────────┼──────────────────────────────────────────┘
                                       │
┌──────────────────────────────────────┼──────────────────────────────────────────┐
│                              API GATEWAY                                         │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                         Nginx / AWS ALB                                  │   │
│  │              (Load Balancing, SSL Termination, Rate Limiting)            │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
└──────────────────────────────────────┼──────────────────────────────────────────┘
                                       │
┌──────────────────────────────────────┼──────────────────────────────────────────┐
│                              BACKEND LAYER                                       │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                     FastAPI (Python 3.11+)                               │   │
│  │  ┌──────────────────────────────────────────────────────────────────┐   │   │
│  │  │                        API Routers                                │   │   │
│  │  │  ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐         │   │   │
│  │  │  │ /auth  │ │ /users │ │/events │ │/subsidy│ │ /sim   │         │   │   │
│  │  │  └────────┘ └────────┘ └────────┘ └────────┘ └────────┘         │   │   │
│  │  └──────────────────────────────────────────────────────────────────┘   │   │
│  │  ┌──────────────────────────────────────────────────────────────────┐   │   │
│  │  │                      Service Layer                                │   │   │
│  │  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐                 │   │   │
│  │  │  │ Auth        │ │ LifeStage   │ │ Subsidy     │                 │   │   │
│  │  │  │ Service     │ │ Service     │ │ Service     │                 │   │   │
│  │  │  └─────────────┘ └─────────────┘ └─────────────┘                 │   │   │
│  │  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐                 │   │   │
│  │  │  │ Simulation  │ │ Notification│ │ External    │                 │   │   │
│  │  │  │ Service     │ │ Service     │ │ API Service │                 │   │   │
│  │  │  └─────────────┘ └─────────────┘ └─────────────┘                 │   │   │
│  │  └──────────────────────────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                      │                                          │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                    Background Workers (Celery)                           │   │
│  │  ┌────────────────┐ ┌────────────────┐ ┌────────────────┐               │   │
│  │  │ Data Sync      │ │ Notification   │ │ Simulation     │               │   │
│  │  │ Worker         │ │ Worker         │ │ Worker         │               │   │
│  │  └────────────────┘ └────────────────┘ └────────────────┘               │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
└──────────────────────────────────────┼──────────────────────────────────────────┘
                                       │
┌──────────────────────────────────────┼──────────────────────────────────────────┐
│                              DATA LAYER                                          │
│  ┌─────────────────────┐ ┌─────────────────────┐ ┌─────────────────────┐        │
│  │    PostgreSQL 15    │ │      Redis 7        │ │   Elasticsearch     │        │
│  │  ┌───────────────┐  │ │  ┌───────────────┐  │ │  ┌───────────────┐  │        │
│  │  │ Users         │  │ │  │ Session Store │  │ │  │ Subsidy Index │  │        │
│  │  │ LifeEvents    │  │ │  │ Cache Layer   │  │ │  │ Full-text     │  │        │
│  │  │ Subsidies     │  │ │  │ Rate Limiter  │  │ │  │ Search        │  │        │
│  │  │ Simulations   │  │ │  │ Job Queue     │  │ │  └───────────────┘  │        │
│  │  │ Notifications │  │ │  └───────────────┘  │ │                     │        │
│  │  └───────────────┘  │ │                     │ │                     │        │
│  └─────────────────────┘ └─────────────────────┘ └─────────────────────┘        │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│                          EXTERNAL INTEGRATIONS                                   │
│  ┌─────────────────────┐ ┌─────────────────────┐ ┌─────────────────────┐        │
│  │   e-Stat API        │ │  都民のくらしむき    │ │  東洋経済データAPI   │        │
│  │  (統計Dashboard)    │ │      API            │ │                     │        │
│  │                     │ │                     │ │                     │        │
│  │ - 人口統計          │ │ - 生活費データ      │ │ - 経済指標          │        │
│  │ - 収入分布          │ │ - 物価情報          │ │ - 地域データ        │        │
│  │ - 社会保障統計      │ │ - 住居費            │ │ - 業界動向          │        │
│  └─────────────────────┘ └─────────────────────┘ └─────────────────────┘        │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 2. データフロー図

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           DATA FLOW ARCHITECTURE                                 │
└─────────────────────────────────────────────────────────────────────────────────┘

[ユーザー操作フロー]

User ──→ Next.js ──→ FastAPI ──→ PostgreSQL
  │         │            │            │
  │         │            │            └──→ ユーザー情報永続化
  │         │            │
  │         │            └──→ Redis (セッション/キャッシュ)
  │         │
  │         └──→ NextAuth (認証処理)
  │
  └──→ WebSocket ──→ Notification Service


[シミュレーションフロー]

                    ┌─────────────────┐
                    │ Simulation      │
User Request ──────→│ Request         │
                    └────────┬────────┘
                             │
              ┌──────────────┼──────────────┐
              │              │              │
              ▼              ▼              ▼
    ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
    │ e-Stat API  │ │ くらしむき   │ │ 東洋経済    │
    │ (統計データ) │ │ API         │ │ API         │
    └──────┬──────┘ └──────┬──────┘ └──────┬──────┘
           │               │               │
           └───────────────┼───────────────┘
                           │
                           ▼
              ┌─────────────────────────┐
              │   Data Aggregation      │
              │   & Normalization       │
              └────────────┬────────────┘
                           │
                           ▼
              ┌─────────────────────────┐
              │   Simulation Engine     │
              │   (3 Scenarios)         │
              │   - Optimistic          │
              │   - Baseline            │
              │   - Conservative        │
              └────────────┬────────────┘
                           │
                           ▼
              ┌─────────────────────────┐
              │   Result Generation     │
              └────────────┬────────────┘
                           │
                           ▼
                      User Response


[通知フロー]

External Data Change ──→ Celery Worker ──→ Check User Preferences
                                                    │
                    ┌───────────────────────────────┼───────────────────────────┐
                    │                               │                           │
                    ▼                               ▼                           ▼
            ┌───────────────┐             ┌───────────────┐           ┌───────────────┐
            │   Push        │             │   Email       │           │   In-App      │
            │   Notification│             │   Notification│           │   Notification│
            └───────────────┘             └───────────────┘           └───────────────┘
```

## 3. デプロイメントアーキテクチャ

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                         DEPLOYMENT ARCHITECTURE (AWS)                            │
└─────────────────────────────────────────────────────────────────────────────────┘

                              ┌─────────────┐
                              │  CloudFront │
                              │  (CDN)      │
                              └──────┬──────┘
                                     │
┌────────────────────────────────────┼────────────────────────────────────────────┐
│  VPC                               │                                             │
│  ┌─────────────────────────────────┼─────────────────────────────────────────┐  │
│  │  Public Subnet                  │                                          │  │
│  │                          ┌──────┴──────┐                                   │  │
│  │                          │     ALB     │                                   │  │
│  │                          └──────┬──────┘                                   │  │
│  └─────────────────────────────────┼─────────────────────────────────────────┘  │
│                                    │                                             │
│  ┌─────────────────────────────────┼─────────────────────────────────────────┐  │
│  │  Private Subnet (Application)   │                                          │  │
│  │           ┌─────────────────────┼─────────────────────┐                   │  │
│  │           │                     │                     │                   │  │
│  │    ┌──────┴──────┐       ┌──────┴──────┐       ┌──────┴──────┐           │  │
│  │    │ ECS Fargate │       │ ECS Fargate │       │ ECS Fargate │           │  │
│  │    │ (Frontend)  │       │ (Backend)   │       │ (Workers)   │           │  │
│  │    └─────────────┘       └─────────────┘       └─────────────┘           │  │
│  └───────────────────────────────────────────────────────────────────────────┘  │
│                                                                                  │
│  ┌───────────────────────────────────────────────────────────────────────────┐  │
│  │  Private Subnet (Data)                                                     │  │
│  │    ┌─────────────┐       ┌─────────────┐       ┌─────────────┐           │  │
│  │    │ RDS         │       │ ElastiCache │       │ OpenSearch  │           │  │
│  │    │ (PostgreSQL)│       │ (Redis)     │       │ Service     │           │  │
│  │    └─────────────┘       └─────────────┘       └─────────────┘           │  │
│  └───────────────────────────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────────────────────────────┘

Additional Services:
┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐
│  S3         │  │  SES        │  │  SNS        │  │  CloudWatch │
│  (Storage)  │  │  (Email)    │  │  (Push)     │  │  (Monitor)  │
└─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘
```

## 4. セキュリティアーキテクチャ

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          SECURITY ARCHITECTURE                                   │
└─────────────────────────────────────────────────────────────────────────────────┘

[認証・認可フロー]

                    ┌─────────────────────────────────────────────┐
                    │              WAF (AWS WAF)                  │
                    │  - SQL Injection Protection                 │
                    │  - XSS Protection                           │
                    │  - Rate Limiting                            │
                    └──────────────────────┬──────────────────────┘
                                           │
                    ┌──────────────────────┴──────────────────────┐
                    │            TLS 1.3 Termination              │
                    └──────────────────────┬──────────────────────┘
                                           │
          ┌────────────────────────────────┼────────────────────────────────┐
          │                                │                                │
          ▼                                ▼                                ▼
┌─────────────────┐              ┌─────────────────┐              ┌─────────────────┐
│  NextAuth.js    │              │  JWT Validation │              │  API Key Auth   │
│  (OAuth 2.0)    │              │  (Access Token) │              │  (External API) │
│  - Google       │              │                 │              │                 │
│  - LINE         │              │  - RS256 Sign   │              │  - HMAC Sign    │
│  - Email/Pass   │              │  - 15min Expiry │              │  - IP Whitelist │
└─────────────────┘              └─────────────────┘              └─────────────────┘


[データ保護]

┌─────────────────────────────────────────────────────────────────────────────────┐
│  Data Classification                                                             │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐                  │
│  │  Confidential   │  │  Internal       │  │  Public         │                  │
│  │  - Password     │  │  - User Profile │  │  - Subsidy Info │                  │
│  │  - Personal ID  │  │  - Life Events  │  │  - Statistics   │                  │
│  │  - Financial    │  │  - Simulations  │  │  - API Docs     │                  │
│  │                 │  │                 │  │                 │                  │
│  │  [AES-256-GCM]  │  │  [At-Rest Enc]  │  │  [No Encryption]│                  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---
**作成日**: 2024-XX-XX
**バージョン**: 1.0
**作成者**: CTO (Chief Technology Officer)
